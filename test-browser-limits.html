<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµè§ˆå™¨æ–‡ä»¶å¤„ç†æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Excelæ–‡ä»¶æµè§ˆå™¨å¤„ç†æµ‹è¯•</h1>
    
    <div class="test-section info">
        <h3>æµ‹è¯•è¯´æ˜</h3>
        <p>æ­¤æµ‹è¯•é¡µé¢ç”¨äºæ£€æµ‹æµè§ˆå™¨å¤„ç†å¤§å‹Excelæ–‡ä»¶çš„èƒ½åŠ›å’Œé™åˆ¶ã€‚</p>
        <p>è¯·åˆ†åˆ«ä¸Šä¼ ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå¯¹æ¯”æµ‹è¯•ï¼š</p>
        <ul>
            <li>æ–‡ä»¶A: 8æœˆç››é‚¦è¯åº—æ‹œè®¿è®°å½•.xlsx (çº¦196MB)</li>
            <li>æ–‡ä»¶B: æç‡•æ‹œè®¿.xlsx (çº¦445MB)</li>
        </ul>
    </div>

    <div class="test-section">
        <h3>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
        <button onclick="testFileProcessing()">å¼€å§‹æµ‹è¯•</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="testResults" class="log">ç­‰å¾…æ–‡ä»¶ä¸Šä¼ ...</div>
    </div>

    <script src="/vendor/xlsx.full.min.js"></script>
    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.textContent = testLog.join('\n');
            
            console.log(logEntry);
        }

        function clearLog() {
            testLog = [];
            document.getElementById('testResults').textContent = 'æ—¥å¿—å·²æ¸…ç©º...';
        }

        async function testFileProcessing() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                log('âŒ è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                return;
            }

            log(`ğŸš€ å¼€å§‹æµ‹è¯•æ–‡ä»¶: ${file.name}`);
            log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            log(`ğŸ“… æ–‡ä»¶ç±»å‹: ${file.type}`);
            log(`ğŸ“… æœ€åä¿®æ”¹: ${new Date(file.lastModified).toLocaleString()}`);

            try {
                // æ­¥éª¤1: æµ‹è¯•æ–‡ä»¶è¯»å–
                log('ğŸ“– æ­¥éª¤1: æµ‹è¯•æ–‡ä»¶è¯»å–...');
                const startTime = performance.now();
                
                let fileBuffer;
                try {
                    fileBuffer = await file.arrayBuffer();
                    const readTime = performance.now() - startTime;
                    log(`âœ… æ–‡ä»¶è¯»å–æˆåŠŸï¼Œè€—æ—¶: ${readTime.toFixed(2)}ms`);
                    log(`ğŸ“Š Bufferå¤§å°: ${(fileBuffer.byteLength / 1024 / 1024).toFixed(2)} MB`);
                } catch (error) {
                    log(`âŒ æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`, 'error');
                    return;
                }

                // æ­¥éª¤2: æµ‹è¯•å†…å­˜ä½¿ç”¨
                log('ğŸ§  æ­¥éª¤2: æ£€æŸ¥å†…å­˜ä½¿ç”¨...');
                if (performance.memory) {
                    const memory = performance.memory;
                    log(`ğŸ’¾ å·²ç”¨å †å†…å­˜: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                    log(`ğŸ’¾ æ€»å †å†…å­˜: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                    log(`ğŸ’¾ å †å†…å­˜é™åˆ¶: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`);
                } else {
                    log('âš ï¸ æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§');
                }

                // æ­¥éª¤3: æµ‹è¯•XLSXè§£æï¼ˆå·¥ä½œè¡¨ä¿¡æ¯ï¼‰
                log('ğŸ“‹ æ­¥éª¤3: è§£æå·¥ä½œè¡¨ä¿¡æ¯...');
                let workbook;
                try {
                    const parseStart = performance.now();
                    workbook = XLSX.read(fileBuffer, {
                        type: "array",
                        bookSheets: true,
                        bookVBA: false,
                        bookProps: false,
                        bookFiles: false,
                        bookDeps: false,
                    });
                    const parseTime = performance.now() - parseStart;
                    log(`âœ… å·¥ä½œè¡¨è§£ææˆåŠŸï¼Œè€—æ—¶: ${parseTime.toFixed(2)}ms`);
                    log(`ğŸ“Š å·¥ä½œè¡¨æ•°é‡: ${workbook.SheetNames.length}`);
                    log(`ğŸ“Š å·¥ä½œè¡¨åç§°: ${workbook.SheetNames.join(', ')}`);
                } catch (error) {
                    if (error.message && error.message.includes("Invalid array length")) {
                        log(`âŒ è§£æå¤±è´¥: Excelæ–‡ä»¶æ ¼å¼å¤æ‚ï¼Œè¯·å°è¯•å‡å°‘æ•°æ®è¡Œæ•°æˆ–ç®€åŒ–å·¥ä½œè¡¨å†…å®¹`, 'error');
                    } else {
                        log(`âŒ è§£æå¤±è´¥: ${error.message}`, 'error');
                    }
                    return;
                }

                // æ­¥éª¤4: æµ‹è¯•å®Œæ•´æ•°æ®è§£æ
                log('ğŸ“Š æ­¥éª¤4: è§£æå®Œæ•´æ•°æ®...');
                try {
                    const dataStart = performance.now();
                    const fullWorkbook = XLSX.read(fileBuffer, { type: "array" });
                    const firstSheet = fullWorkbook.Sheets[workbook.SheetNames[0]];
                    
                    const data = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        defval: "",
                        raw: false,
                        dateNF: "yyyy-mm-dd",
                    });
                    
                    const dataTime = performance.now() - dataStart;
                    log(`âœ… æ•°æ®è§£ææˆåŠŸï¼Œè€—æ—¶: ${dataTime.toFixed(2)}ms`);
                    log(`ğŸ“Š æ•°æ®è¡Œæ•°: ${data.length}`);
                    
                    // æ£€æŸ¥è¡Œæ•°é™åˆ¶
                    if (data.length > 50000) {
                        log(`âš ï¸ è­¦å‘Š: æ•°æ®è¡Œæ•° (${data.length}) è¶…è¿‡ç³»ç»Ÿé™åˆ¶ (50,000 è¡Œ)`, 'warning');
                    }
                    
                } catch (error) {
                    if (error.message && error.message.includes("Invalid array length")) {
                        log(`âŒ æ•°æ®è§£æå¤±è´¥: å·¥ä½œè¡¨æ•°æ®è¿‡å¤§ï¼Œè¯·å‡å°‘æ•°æ®è¡Œæ•°æˆ–ç®€åŒ–å†…å®¹`, 'error');
                    } else {
                        log(`âŒ æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
                    }
                    return;
                }

                // æ­¥éª¤5: æµ‹è¯•Web Workerå…¼å®¹æ€§
                log('ğŸ”§ æ­¥éª¤5: æµ‹è¯•Web Workerå¤„ç†...');
                try {
                    const worker = new Worker('/validation-worker.js');
                    
                    const workerPromise = new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            worker.terminate();
                            reject(new Error('Workerè¶…æ—¶'));
                        }, 30000); // 30ç§’è¶…æ—¶

                        worker.onmessage = (e) => {
                            clearTimeout(timeout);
                            worker.terminate();
                            resolve(e.data);
                        };

                        worker.onerror = (error) => {
                            clearTimeout(timeout);
                            worker.terminate();
                            reject(error);
                        };

                        // å‘é€æµ‹è¯•æ¶ˆæ¯
                        worker.postMessage({
                            type: 'VALIDATE_EXCEL',
                            data: {
                                fileBuffer: fileBuffer,
                                taskName: 'è¯åº—æ‹œè®¿',
                                selectedSheet: workbook.SheetNames[0],
                                template: { validationRules: [] },
                                includeImages: false
                            }
                        });
                    });

                    const workerResult = await workerPromise;
                    log(`âœ… Web Workerå¤„ç†æˆåŠŸ`);
                    
                } catch (error) {
                    log(`âŒ Web Workerå¤„ç†å¤±è´¥: ${error.message}`, 'error');
                }

                // æœ€ç»ˆå†…å­˜æ£€æŸ¥
                log('ğŸ æ­¥éª¤6: æœ€ç»ˆå†…å­˜æ£€æŸ¥...');
                if (performance.memory) {
                    const finalMemory = performance.memory;
                    log(`ğŸ’¾ æœ€ç»ˆå·²ç”¨å †å†…å­˜: ${(finalMemory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                    log(`ğŸ’¾ æœ€ç»ˆæ€»å †å†…å­˜: ${(finalMemory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                }

                log(`ğŸ‰ æµ‹è¯•å®Œæˆï¼æ–‡ä»¶ ${file.name} å¤„ç†æˆåŠŸ`);

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                log(`ğŸ“ é”™è¯¯å †æ ˆ: ${error.stack}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œè¯·é€‰æ‹©Excelæ–‡ä»¶è¿›è¡Œæµ‹è¯•');
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if (typeof Worker === 'undefined') {
                log('âš ï¸ è­¦å‘Š: æµè§ˆå™¨ä¸æ”¯æŒWeb Worker', 'warning');
            }
            
            if (typeof XLSX === 'undefined') {
                log('âŒ é”™è¯¯: XLSXåº“æœªåŠ è½½', 'error');
            } else {
                log('âœ… XLSXåº“å·²åŠ è½½');
            }
        });
    </script>
</body>
</html>
