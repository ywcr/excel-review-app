# 图片水印检测功能说明

## 功能概述

Excel审核应用现已集成图片水印检测功能，能够自动识别Excel文件中包含水印的图片，并在验证报告中标记为不合格。

## 技术实现

### 1. 检测算法

水印检测采用多种图像分析算法的组合：

#### 透明度分析 (Transparency Analysis)
- 检测半透明像素的分布
- 识别透明水印和半透明覆盖层
- 阈值：15% 的半透明像素比例

#### 边缘密度分析 (Edge Density Analysis)  
- 使用Sobel算子进行边缘检测
- 识别文字水印和图标水印的边缘特征
- 阈值：30% 的边缘像素密度

#### 模式重复分析 (Pattern Repetition Analysis)
- 将图片分割为16x16像素块
- 计算块之间的相似性
- 识别重复的水印图案
- 阈值：70% 的模式重复率

#### 颜色方差分析 (Color Variance Analysis)
- 分析图片颜色分布的方差
- 识别单调颜色的水印区域
- 阈值：20% 的颜色方差

### 2. 综合判断

系统采用加权评分机制：
- 透明度分析：30% 权重
- 边缘密度分析：25% 权重  
- 模式重复分析：25% 权重
- 颜色方差分析：20% 权重

**水印判定条件**：
- 至少2种检测方法触发阈值，或
- 综合置信度超过70%

## 用户界面

### 1. 验证摘要
在图片验证摘要中新增"水印图片"统计：
- 显示检测到水印的图片数量
- 紫色标识区分其他问题类型

### 2. 水印警告
当检测到水印图片时，显示紫色警告框：
```
⚠️ 水印检测警告：检测到 X 张图片包含水印。
包含水印的图片可能不符合提交要求，请检查并替换为无水印的原始图片。
```

### 3. 详细报告
在图片问题详情表格中新增"水印检测"列：
- 显示"有水印"/"无水印"状态
- 显示检测置信度百分比
- 列出触发的检测方法

## 性能优化

### 1. 图片预处理
- 将图片缩放到128x128像素进行分析
- 减少计算复杂度，提高检测速度

### 2. 并发控制
- 与现有的图片验证流程集成
- 串行处理避免内存溢出
- 支持大量图片的批量检测

### 3. 兼容性处理
- 支持OffscreenCanvas的现代浏览器
- 降级处理：不支持时返回默认结果
- 错误处理：检测失败时不影响整体验证

## 支持的图片格式

- PNG (推荐，支持透明度检测)
- JPG/JPEG (支持，但透明度检测有限)
- 其他Canvas支持的格式

## 使用场景

### 1. 医院拜访记录
- 检测拜访照片是否包含水印
- 确保提交的是原始拍摄照片

### 2. 药店拜访记录  
- 验证店铺照片的真实性
- 防止使用带水印的网络图片

### 3. 其他业务场景
- 任何需要原始图片的验证场景
- 防止使用第三方带水印图片

## 配置参数

可在代码中调整的检测参数：

```javascript
const WATERMARK_CONFIG = {
  TRANSPARENCY_THRESHOLD: 0.15,      // 透明度阈值
  EDGE_DENSITY_THRESHOLD: 0.3,       // 边缘密度阈值  
  PATTERN_REPETITION_THRESHOLD: 0.7, // 模式重复阈值
  COLOR_VARIANCE_THRESHOLD: 0.2,     // 颜色方差阈值
  ANALYSIS_SIZE: 128,                // 分析图片尺寸
};
```

## 注意事项

1. **检测准确性**：算法基于常见水印特征，可能存在误判
2. **性能影响**：增加了图片处理时间，但已优化到最小
3. **浏览器兼容性**：需要支持Canvas API和OffscreenCanvas
4. **文件格式限制**：仅支持.xlsx格式的Excel文件中的图片

## 未来改进

1. **机器学习模型**：集成更精确的AI水印检测模型
2. **自定义阈值**：允许用户根据业务需求调整检测敏感度
3. **水印类型识别**：区分不同类型的水印（文字、图标、品牌等）
4. **批量处理优化**：进一步优化大量图片的处理性能
