// 基于真实模板结构创建包含数据的测试文件
const XLSX = require('xlsx');
const path = require('path');
const fs = require('fs');

function createRealDataTestFile() {
  // 基于真实模板的表头结构（第3行）
  const headers = [
    '序号',
    '任务标题', 
    '实施\n人',
    '对接人',
    '零售渠道',
    '渠道地址',
    '拜访开始\n时间',
    '拜访时长',
    '拜访事项\n（1）',
    '信息反馈（1）',
    '拜访事项\n（2）',
    '信息反馈（2）',
    '门头',
    '内部'
  ];

  // 创建测试数据
  const data = [
    ['     月拜访记录表'], // 第1行：标题
    [], // 第2行：空行
    headers, // 第3行：表头
    [
      1,
      '某公司产品北京市药店拜访',
      '张三',
      '王经理',
      '康美药店',
      '北京市朝阳区建国路1号',
      '2024-01-15 09:00',
      90,
      '产品推广',
      '客户反馈良好',
      '价格咨询',
      '价格合理',
      '已拍摄',
      '已拍摄'
    ],
    [
      2,
      '某公司产品北京市药店拜访',
      '李四',
      '李经理',
      '同仁堂药店',
      '北京市西城区前门大街2号',
      '2024-01-15 11:00',
      60,
      '产品介绍',
      '有购买意向',
      '库存了解',
      '库存充足',
      '已拍摄',
      '已拍摄'
    ],
    [
      3,
      '某公司产品北京市药店拜访',
      '张三',
      '赵经理',
      '老百姓药店',
      '北京市海淀区中关村大街3号',
      '2024-01-16 14:00',
      90,
      '市场调研',
      '竞品分析',
      '销售策略',
      '制定方案',
      '已拍摄',
      '已拍摄'
    ],
    [
      4,
      '某公司产品北京市药店拜访',
      '', // 缺少实施人 - 应该报错
      '陈经理',
      '益丰药房',
      '北京市东城区王府井大街4号',
      '2024-01-16 10:00',
      75,
      '客户维护',
      '关系良好',
      '后续合作',
      '达成意向',
      '已拍摄',
      '已拍摄'
    ],
    [
      5,
      '某公司产品北京市药店拜访',
      '李四',
      '刘经理',
      '', // 缺少零售渠道 - 应该报错
      '北京市丰台区南三环路5号',
      '2024-01-17 09:30',
      90,
      '新品推介',
      '接受度高',
      '订单洽谈',
      '签订合同',
      '已拍摄',
      '已拍摄'
    ],
    [
      6,
      '某公司产品北京市药店拜访',
      '王五',
      '孙经理',
      '大参林药店',
      '北京市石景山区八角路6号',
      '无效日期', // 日期格式错误 - 应该报错
      60,
      '产品培训',
      '效果良好',
      '技术支持',
      '满意度高',
      '已拍摄',
      '已拍摄'
    ],
    [
      7,
      '某公司产品北京市药店拜访',
      '张三',
      '王经理',
      '康美药店', // 重复药店 - 应该报错（unique规则）
      '北京市朝阳区建国路1号',
      '2024-01-15 10:00',
      30, // 时长不足60分钟 - 应该报错
      '回访客户',
      '关系维护',
      '后续跟进',
      '继续合作',
      '已拍摄',
      '已拍摄'
    ]
  ];

  // 创建工作簿
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '药店拜访');

  // 确保目录存在
  const testDir = path.join(__dirname, '../public/test-files');
  if (!fs.existsSync(testDir)) {
    fs.mkdirSync(testDir, { recursive: true });
  }

  // 保存文件
  const filePath = path.join(testDir, '药店拜访_真实数据测试.xlsx');
  XLSX.writeFile(wb, filePath);

  console.log('✅ 创建成功:', filePath);
  console.log('\n📊 测试文件包含:');
  console.log('- 第1行: 标题行');
  console.log('- 第2行: 空行');
  console.log('- 第3行: 表头行（包含换行符）');
  console.log('- 第4-10行: 7行测试数据');
  console.log('\n🎯 预期验证结果:');
  console.log('- 总行数: 7行');
  console.log('- 错误数: 5个');
  console.log('  * 第7行: 实施人不能为空');
  console.log('  * 第8行: 零售渠道不能为空');
  console.log('  * 第9行: 拜访开始时间格式不正确');
  console.log('  * 第10行: 同一零售渠道1日内不能重复拜访');
  console.log('  * 第10行: 拜访时长不足60分钟');
}

// 运行创建
console.log('🚀 开始创建包含真实数据的测试文件...\n');
createRealDataTestFile();
console.log('\n✅ 创建完成！现在可以用这个文件测试前端验证功能了。');
