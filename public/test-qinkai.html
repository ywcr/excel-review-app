<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>测试秦凯文件解析</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>测试秦凯文件解析</h1>
    <button onclick="testQinkaiFile()">测试秦凯拜访.xlsx</button>
    <div id="result"></div>

    <script>
        async function testQinkaiFile() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>正在测试秦凯文件...</p>';
            
            try {
                // 加载秦凯文件
                const response = await fetch('/data/秦凯拜访.xlsx');
                if (!response.ok) {
                    throw new Error(`文件加载失败: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                console.log('文件大小:', (arrayBuffer.byteLength / 1024 / 1024).toFixed(2), 'MB');
                
                // 测试1: 直接解析（类似测试文件的方式）
                resultDiv.innerHTML += '<h2>测试1: 直接解析</h2>';
                
                try {
                    const workbook = XLSX.read(arrayBuffer, {
                        type: "array",
                        cellDates: true,
                        dense: false,
                        sheetStubs: false,
                        bookVBA: false,
                        bookProps: false,
                        bookFiles: false,
                        bookDeps: false,
                        raw: false
                    });
                    
                    resultDiv.innerHTML += '<p style="color: green;">✅ 直接解析成功!</p>';
                    resultDiv.innerHTML += `<p>工作表: ${workbook.SheetNames.join(', ')}</p>`;
                    
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(firstSheet, {
                        header: 1,
                        defval: "",
                        raw: false,
                        dateNF: "yyyy-mm-dd"
                    });
                    
                    resultDiv.innerHTML += `<p>总行数: ${data.length}</p>`;
                    resultDiv.innerHTML += `<p>工作表范围: ${firstSheet['!ref'] || '无'}</p>`;
                    
                    // 显示前几行数据
                    resultDiv.innerHTML += '<h3>前5行数据:</h3>';
                    for (let i = 0; i < Math.min(5, data.length); i++) {
                        const row = data[i];
                        resultDiv.innerHTML += `<p>第${i+1}行: ${JSON.stringify(row?.slice(0, 5) || [])}</p>`;
                    }
                    
                } catch (error) {
                    resultDiv.innerHTML += `<p style="color: red;">❌ 直接解析失败: ${error.message}</p>`;
                    console.error('直接解析错误:', error);
                }
                
                // 测试2: 使用当前Worker的解析选项
                resultDiv.innerHTML += '<h2>测试2: Worker解析选项</h2>';
                
                try {
                    const parseOptions = {
                        type: "array",
                        cellDates: true,
                        cellNF: false,
                        cellText: false,
                        dense: false,
                        sheetStubs: false,
                        bookVBA: false,
                        bookSheets: false,
                        bookProps: false,
                        bookFiles: false,
                        bookDeps: false,
                        raw: false,
                    };
                    
                    console.log('Worker解析选项:', parseOptions);
                    const workbook2 = XLSX.read(arrayBuffer, parseOptions);
                    
                    resultDiv.innerHTML += '<p style="color: green;">✅ Worker选项解析成功!</p>';
                    resultDiv.innerHTML += `<p>工作表: ${workbook2.SheetNames.join(', ')}</p>`;
                    resultDiv.innerHTML += `<p>Sheets对象: ${workbook2.Sheets ? '存在' : '不存在'}</p>`;
                    
                    if (workbook2.Sheets) {
                        resultDiv.innerHTML += `<p>可用工作表: ${Object.keys(workbook2.Sheets).join(', ')}</p>`;
                        
                        const firstSheet2 = workbook2.Sheets[workbook2.SheetNames[0]];
                        if (firstSheet2) {
                            resultDiv.innerHTML += `<p>第一个工作表范围: ${firstSheet2['!ref'] || '无'}</p>`;
                            
                            const data2 = XLSX.utils.sheet_to_json(firstSheet2, {
                                header: 1,
                                defval: "",
                                raw: false,
                                dateNF: "yyyy-mm-dd"
                            });
                            
                            resultDiv.innerHTML += `<p>数据行数: ${data2.length}</p>`;
                        }
                    }
                    
                } catch (error) {
                    resultDiv.innerHTML += `<p style="color: red;">❌ Worker选项解析失败: ${error.message}</p>`;
                    console.error('Worker选项解析错误:', error);
                }
                
                // 测试3: 使用Worker验证
                resultDiv.innerHTML += '<h2>测试3: Worker验证</h2>';
                
                const worker = new Worker('/validation-worker.js');
                
                worker.onmessage = (e) => {
                    const { type, data } = e.data;
                    console.log('Worker消息:', type, data);
                    
                    if (type === 'PROGRESS') {
                        resultDiv.innerHTML += `<p>进度: ${data.message} (${data.progress}%)</p>`;
                    } else if (type === 'RESULT') {
                        if (data && data.needSheetSelection) {
                            resultDiv.innerHTML += '<p style="color: orange;">🔄 需要用户选择工作表</p>';
                            resultDiv.innerHTML += '<p>可用工作表:</p>';
                            resultDiv.innerHTML += '<ul>';
                            data.availableSheets.forEach(sheet => {
                                resultDiv.innerHTML += `<li>${sheet.name} (${sheet.hasData ? '有数据' : '无数据'})</li>`;
                            });
                            resultDiv.innerHTML += '</ul>';
                        } else {
                            resultDiv.innerHTML += '<p style="color: green;">✅ Worker验证成功!</p>';
                            resultDiv.innerHTML += '<h3>验证结果详情:</h3>';

                            // 显示基本信息
                            if (data.summary) {
                                resultDiv.innerHTML += `<p><strong>总行数:</strong> ${data.summary.totalRows}</p>`;
                                resultDiv.innerHTML += `<p><strong>有效行数:</strong> ${data.summary.validRows}</p>`;
                                resultDiv.innerHTML += `<p><strong>错误数量:</strong> ${data.summary.errorCount}</p>`;
                            }

                            // 显示表头验证
                            if (data.headerValidation) {
                                resultDiv.innerHTML += '<h4>表头验证:</h4>';
                                resultDiv.innerHTML += `<p>表头有效: ${data.headerValidation.isValid ? '✅' : '❌'}</p>`;
                                if (data.headerValidation.missingFields && data.headerValidation.missingFields.length > 0) {
                                    resultDiv.innerHTML += `<p>缺失字段: ${data.headerValidation.missingFields.join(', ')}</p>`;
                                }
                            }

                            // 显示错误详情
                            if (data.errors && data.errors.length > 0) {
                                resultDiv.innerHTML += '<h4>验证错误:</h4>';
                                resultDiv.innerHTML += `<p>共 ${data.errors.length} 个错误</p>`;
                                resultDiv.innerHTML += '<ul>';
                                data.errors.slice(0, 10).forEach(error => {
                                    resultDiv.innerHTML += `<li>第${error.row}行 ${error.column}列: ${error.message}</li>`;
                                });
                                if (data.errors.length > 10) {
                                    resultDiv.innerHTML += `<li>... 还有 ${data.errors.length - 10} 个错误</li>`;
                                }
                                resultDiv.innerHTML += '</ul>';
                            } else {
                                resultDiv.innerHTML += '<p style="color: green;">🎉 没有发现验证错误！</p>';
                            }

                            // 显示图片验证结果
                            if (data.imageValidation) {
                                resultDiv.innerHTML += '<h4>图片验证:</h4>';
                                resultDiv.innerHTML += `<p>总图片数: ${data.imageValidation.totalImages}</p>`;
                                resultDiv.innerHTML += `<p>模糊图片: ${data.imageValidation.blurryImages}</p>`;
                                resultDiv.innerHTML += `<p>重复图片组: ${data.imageValidation.duplicateGroups}</p>`;
                            }

                            // 显示完整的原始数据（用于调试）
                            resultDiv.innerHTML += '<details><summary>完整验证结果（调试用）</summary>';
                            resultDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                            resultDiv.innerHTML += '</details>';
                        }
                        worker.terminate();
                    } else if (type === 'ERROR') {
                        resultDiv.innerHTML += `<p style="color: red;">❌ Worker验证失败: ${data.message}</p>`;
                        worker.terminate();
                    }
                };
                
                worker.onerror = (error) => {
                    resultDiv.innerHTML += `<p style="color: red;">❌ Worker错误: ${error.message}</p>`;
                };
                
                // 发送验证请求
                worker.postMessage({
                    type: 'VALIDATE_EXCEL',
                    data: {
                        fileBuffer: arrayBuffer,
                        taskName: 'yuyuan',
                        selectedSheet: undefined,
                        template: {
                            requiredFields: ['序号', '任务标题', '实施人', '对接人', '零售渠道'],
                            sheetNames: ['Sheet1', '药店拜访', '拜访记录'],
                            name: '药店拜访记录验证'
                        },
                        includeImages: false
                    }
                });
                
            } catch (error) {
                console.error('测试错误:', error);
                resultDiv.innerHTML += `<p style="color: red;">测试失败: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
