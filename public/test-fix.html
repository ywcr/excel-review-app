<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•ä¿®å¤åçš„è§£æ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>æµ‹è¯•ä¿®å¤åçš„è§£æ</h1>
    <input type="file" id="fileInput" accept=".xlsx,.xls">
    <div id="result"></div>

    <script>
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•...</p>';
            
            try {
                // æµ‹è¯•1: ä½¿ç”¨ä¿®å¤åçš„Worker
                resultDiv.innerHTML += '<h2>æµ‹è¯•1: ä½¿ç”¨ä¿®å¤åçš„Worker</h2>';
                
                const worker = new Worker('/validation-worker.js');
                const fileBuffer = await file.arrayBuffer();
                
                worker.onmessage = (e) => {
                    const { type, data } = e.data;
                    console.log('Workeræ¶ˆæ¯:', type, data);
                    
                    if (type === 'PROGRESS') {
                        resultDiv.innerHTML += `<p>è¿›åº¦: ${data.message} (${data.progress}%)</p>`;
                    } else if (type === 'RESULT') {
                        if (data && data.needSheetSelection) {
                            resultDiv.innerHTML += '<p style="color: orange;">ğŸ”„ éœ€è¦ç”¨æˆ·é€‰æ‹©å·¥ä½œè¡¨</p>';
                            resultDiv.innerHTML += '<p>å¯ç”¨å·¥ä½œè¡¨:</p>';
                            resultDiv.innerHTML += '<ul>';
                            data.availableSheets.forEach(sheet => {
                                resultDiv.innerHTML += `<li>${sheet.name} (${sheet.hasData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'})</li>`;
                            });
                            resultDiv.innerHTML += '</ul>';

                            // æµ‹è¯•1b: ç”¨æˆ·é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„å·¥ä½œè¡¨
                            const firstDataSheet = data.availableSheets.find(s => s.hasData);
                            if (firstDataSheet) {
                                resultDiv.innerHTML += '<h3>æµ‹è¯•1b: ç”¨æˆ·é€‰æ‹©å·¥ä½œè¡¨</h3>';
                                worker.postMessage({
                                    type: 'VALIDATE_EXCEL',
                                    data: {
                                        fileBuffer: fileBuffer,
                                        taskName: 'yuyuan',
                                        selectedSheet: firstDataSheet.name, // ç”¨æˆ·é€‰æ‹©çš„å·¥ä½œè¡¨
                                        template: {
                                            requiredFields: ['åºå·', 'å§“å', 'èº«ä»½è¯å·'],
                                            sheetNames: ['äºæºæ•°æ®', 'æ•°æ®è¡¨', 'Sheet1'],
                                            name: 'äºæºæ–‡ä»¶éªŒè¯'
                                        },
                                        includeImages: false
                                    }
                                });
                            }
                        } else {
                            resultDiv.innerHTML += '<p style="color: green;">âœ… Workerè§£ææˆåŠŸ!</p>';
                            resultDiv.innerHTML += `<p>æ€»è¡Œæ•°: ${data.summary?.totalRows || 'æœªçŸ¥'}</p>`;
                            resultDiv.innerHTML += `<p>æœ‰æ•ˆè¡Œæ•°: ${data.summary?.validRows || 'æœªçŸ¥'}</p>`;
                            resultDiv.innerHTML += `<p>é”™è¯¯æ•°: ${data.summary?.errorCount || 'æœªçŸ¥'}</p>`;
                            worker.terminate();
                        }
                    } else if (type === 'ERROR') {
                        resultDiv.innerHTML += `<p style="color: red;">âŒ Workerè§£æå¤±è´¥: ${data.message}</p>`;
                        worker.terminate();
                    }
                };
                
                worker.onerror = (error) => {
                    resultDiv.innerHTML += `<p style="color: red;">âŒ Workeré”™è¯¯: ${error.message}</p>`;
                };
                
                // æµ‹è¯•1a: ä¸æŒ‡å®šå·¥ä½œè¡¨ï¼Œæµ‹è¯•è‡ªåŠ¨åŒ¹é…
                resultDiv.innerHTML += '<h3>æµ‹è¯•1a: è‡ªåŠ¨å·¥ä½œè¡¨åŒ¹é…</h3>';
                worker.postMessage({
                    type: 'VALIDATE_EXCEL',
                    data: {
                        fileBuffer: fileBuffer,
                        taskName: 'yuyuan',
                        selectedSheet: undefined, // ä¸æŒ‡å®šå·¥ä½œè¡¨
                        template: {
                            requiredFields: ['åºå·', 'å§“å', 'èº«ä»½è¯å·'],
                            sheetNames: ['äºæºæ•°æ®', 'æ•°æ®è¡¨', 'Sheet1'], // æ¨¡æ¿æœŸæœ›çš„å·¥ä½œè¡¨å
                            name: 'äºæºæ–‡ä»¶éªŒè¯'
                        },
                        includeImages: false
                    }
                });
                
                // æµ‹è¯•2: ç›´æ¥è§£æå¯¹æ¯”
                resultDiv.innerHTML += '<h2>æµ‹è¯•2: ç›´æ¥è§£æå¯¹æ¯”</h2>';
                
                const workbook = XLSX.read(fileBuffer, {
                    type: "array",
                    cellDates: true,
                    dense: false,
                    sheetStubs: false,
                    bookVBA: false,
                    bookProps: false,
                    bookFiles: false,
                    bookDeps: false,
                    raw: false
                });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet, {
                    header: 1,
                    defval: "",
                    raw: false,
                    dateNF: "yyyy-mm-dd"
                });
                
                resultDiv.innerHTML += '<p style="color: green;">âœ… ç›´æ¥è§£ææˆåŠŸ!</p>';
                resultDiv.innerHTML += `<p>å·¥ä½œè¡¨: ${workbook.SheetNames.join(', ')}</p>`;
                resultDiv.innerHTML += `<p>æ€»è¡Œæ•°: ${data.length}</p>`;
                
                // æŸ¥æ‰¾åŒ…å«"åºå·"çš„è¡Œ
                let foundHeaderRow = false;
                for (let i = 0; i < Math.min(20, data.length); i++) {
                    const row = data[i];
                    if (row && row.some(cell => String(cell || '').includes('åºå·'))) {
                        resultDiv.innerHTML += `<p style="color: blue;">æ‰¾åˆ°è¡¨å¤´è¡Œ: ç¬¬${i+1}è¡Œ</p>`;
                        foundHeaderRow = true;
                        break;
                    }
                }
                if (!foundHeaderRow) {
                    resultDiv.innerHTML += '<p style="color: orange;">æœªæ‰¾åˆ°åŒ…å«"åºå·"çš„è¡¨å¤´è¡Œ</p>';
                }
                
            } catch (error) {
                console.error('æµ‹è¯•é”™è¯¯:', error);
                resultDiv.innerHTML += `<p style="color: red;">æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
