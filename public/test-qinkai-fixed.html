<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•ç§¦å‡¯æ–‡ä»¶è§£æ - ä¿®å¤ç‰ˆ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <h1>æµ‹è¯•ç§¦å‡¯æ–‡ä»¶è§£æ - ä¿®å¤ç‰ˆ</h1>
    <button onclick="testQinkaiFile()">æµ‹è¯•ç§¦å‡¯æ‹œè®¿.xlsx (æ­£ç¡®æ¨¡æ¿)</button>
    <div id="result"></div>

    <script>
        async function testQinkaiFile() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p>æ­£åœ¨æµ‹è¯•ç§¦å‡¯æ–‡ä»¶...</p>';
            
            try {
                // åŠ è½½ç§¦å‡¯æ–‡ä»¶
                const response = await fetch('/data/ç§¦å‡¯æ‹œè®¿.xlsx');
                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶åŠ è½½å¤±è´¥: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                console.log('æ–‡ä»¶å¤§å°:', (arrayBuffer.byteLength / 1024 / 1024).toFixed(2), 'MB');
                
                // æµ‹è¯•WorkeréªŒè¯ - ä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿
                resultDiv.innerHTML += '<h2>WorkeréªŒè¯ (æ­£ç¡®æ¨¡æ¿)</h2>';
                
                const worker = new Worker('/validation-worker.js');
                
                worker.onmessage = (e) => {
                    const { type, data } = e.data;
                    console.log('Workeræ¶ˆæ¯:', type, data);
                    
                    if (type === 'PROGRESS') {
                        resultDiv.innerHTML += `<p>è¿›åº¦: ${data.message} (${data.progress}%)</p>`;
                    } else if (type === 'RESULT') {
                        if (data && data.needSheetSelection) {
                            resultDiv.innerHTML += '<p style="color: orange;">ğŸ”„ éœ€è¦ç”¨æˆ·é€‰æ‹©å·¥ä½œè¡¨</p>';
                            resultDiv.innerHTML += '<p>å¯ç”¨å·¥ä½œè¡¨:</p>';
                            resultDiv.innerHTML += '<ul>';
                            data.availableSheets.forEach(sheet => {
                                resultDiv.innerHTML += `<li>${sheet.name} (${sheet.hasData ? 'æœ‰æ•°æ®' : 'æ— æ•°æ®'})</li>`;
                            });
                            resultDiv.innerHTML += '</ul>';
                        } else {
                            resultDiv.innerHTML += '<p style="color: green;">âœ… WorkeréªŒè¯æˆåŠŸ!</p>';
                            resultDiv.innerHTML += '<h3>éªŒè¯ç»“æœè¯¦æƒ…:</h3>';
                            
                            // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                            if (data.summary) {
                                resultDiv.innerHTML += `<p><strong>æ€»è¡Œæ•°:</strong> ${data.summary.totalRows}</p>`;
                                resultDiv.innerHTML += `<p><strong>æœ‰æ•ˆè¡Œæ•°:</strong> ${data.summary.validRows}</p>`;
                                resultDiv.innerHTML += `<p><strong>é”™è¯¯æ•°é‡:</strong> ${data.summary.errorCount}</p>`;
                            }
                            
                            // æ˜¾ç¤ºè¡¨å¤´éªŒè¯
                            if (data.headerValidation) {
                                resultDiv.innerHTML += '<h4>è¡¨å¤´éªŒè¯:</h4>';
                                resultDiv.innerHTML += `<p>è¡¨å¤´æœ‰æ•ˆ: ${data.headerValidation.isValid ? 'âœ…' : 'âŒ'}</p>`;
                                resultDiv.innerHTML += `<p>è¡¨å¤´è¡Œç´¢å¼•: ${data.headerValidation.headerRowIndex}</p>`;
                                if (data.headerValidation.missingFields && data.headerValidation.missingFields.length > 0) {
                                    resultDiv.innerHTML += `<p style="color: red;">ç¼ºå¤±å­—æ®µ: ${data.headerValidation.missingFields.join(', ')}</p>`;
                                }
                                if (data.headerValidation.unmatchedFields && data.headerValidation.unmatchedFields.length > 0) {
                                    resultDiv.innerHTML += `<p style="color: orange;">æœªåŒ¹é…å­—æ®µ: ${data.headerValidation.unmatchedFields.join(', ')}</p>`;
                                }
                            }
                            
                            // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
                            if (data.errors && data.errors.length > 0) {
                                resultDiv.innerHTML += '<h4>éªŒè¯é”™è¯¯:</h4>';
                                resultDiv.innerHTML += `<p>å…± ${data.errors.length} ä¸ªé”™è¯¯</p>`;
                                resultDiv.innerHTML += '<ul>';
                                data.errors.slice(0, 10).forEach(error => {
                                    resultDiv.innerHTML += `<li>ç¬¬${error.row}è¡Œ ${error.column}åˆ—: ${error.message}</li>`;
                                });
                                if (data.errors.length > 10) {
                                    resultDiv.innerHTML += `<li>... è¿˜æœ‰ ${data.errors.length - 10} ä¸ªé”™è¯¯</li>`;
                                }
                                resultDiv.innerHTML += '</ul>';
                            } else {
                                resultDiv.innerHTML += '<p style="color: green;">ğŸ‰ æ²¡æœ‰å‘ç°éªŒè¯é”™è¯¯ï¼</p>';
                            }
                            
                            // æ˜¾ç¤ºå›¾ç‰‡éªŒè¯ç»“æœ
                            if (data.imageValidation) {
                                resultDiv.innerHTML += '<h4>å›¾ç‰‡éªŒè¯:</h4>';
                                resultDiv.innerHTML += `<p>æ€»å›¾ç‰‡æ•°: ${data.imageValidation.totalImages}</p>`;
                                resultDiv.innerHTML += `<p>æ¨¡ç³Šå›¾ç‰‡: ${data.imageValidation.blurryImages}</p>`;
                                resultDiv.innerHTML += `<p>é‡å¤å›¾ç‰‡ç»„: ${data.imageValidation.duplicateGroups}</p>`;
                            }
                            
                            // æ˜¾ç¤ºå®Œæ•´çš„åŸå§‹æ•°æ®ï¼ˆç”¨äºè°ƒè¯•ï¼‰
                            resultDiv.innerHTML += '<details><summary>å®Œæ•´éªŒè¯ç»“æœï¼ˆè°ƒè¯•ç”¨ï¼‰</summary>';
                            resultDiv.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                            resultDiv.innerHTML += '</details>';
                        }
                        worker.terminate();
                    } else if (type === 'ERROR') {
                        resultDiv.innerHTML += `<p style="color: red;">âŒ WorkeréªŒè¯å¤±è´¥: ${data.message}</p>`;
                        worker.terminate();
                    }
                };
                
                worker.onerror = (error) => {
                    resultDiv.innerHTML += `<p style="color: red;">âŒ Workeré”™è¯¯: ${error.message}</p>`;
                };
                
                // å‘é€éªŒè¯è¯·æ±‚ - ä½¿ç”¨æ­£ç¡®çš„è¯åº—æ‹œè®¿æ¨¡æ¿
                console.log('å‘é€éªŒè¯è¯·æ±‚ï¼Œä½¿ç”¨è¯åº—æ‹œè®¿æ¨¡æ¿...');
                worker.postMessage({
                    type: 'VALIDATE_EXCEL',
                    data: {
                        fileBuffer: arrayBuffer,
                        taskName: 'drugstore_visit', // è¯åº—æ‹œè®¿ä»»åŠ¡
                        selectedSheet: undefined,
                        template: {
                            requiredFields: ['åºå·', 'ä»»åŠ¡æ ‡é¢˜', 'å®æ–½äºº', 'å¯¹æ¥äºº', 'é›¶å”®æ¸ é“'],
                            sheetNames: ['Sheet1', 'è¯åº—æ‹œè®¿', 'æ‹œè®¿è®°å½•'],
                            name: 'è¯åº—æ‹œè®¿è®°å½•éªŒè¯',
                            // æ·»åŠ ä¸€äº›éªŒè¯è§„åˆ™
                            validationRules: [
                                {
                                    field: 'åºå·',
                                    type: 'required',
                                    message: 'åºå·ä¸èƒ½ä¸ºç©º'
                                },
                                {
                                    field: 'ä»»åŠ¡æ ‡é¢˜',
                                    type: 'required',
                                    message: 'ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º'
                                },
                                {
                                    field: 'å®æ–½äºº',
                                    type: 'required',
                                    message: 'å®æ–½äººä¸èƒ½ä¸ºç©º'
                                }
                            ]
                        },
                        includeImages: false
                    }
                });
                
            } catch (error) {
                console.error('æµ‹è¯•é”™è¯¯:', error);
                resultDiv.innerHTML += `<p style="color: red;">æµ‹è¯•å¤±è´¥: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
