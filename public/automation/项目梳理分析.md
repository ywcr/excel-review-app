# 问卷自动化工具项目梳理与API模式完善分析

## 一、项目概述

### 1.1 项目背景
这是一个问卷自动化填写工具，主要用于批量创建和提交各类医疗问卷（六味患者、西黄消费者、牛解消费者、知柏消费者、贴膏患者等）。

### 1.2 技术架构
- **前端技术**: HTML + JavaScript (原生JS)
- **数据处理**: Excel文件解析 (ExcelJS库)
- **执行模式**: 支持DOM模式和API模式两种方式

## 二、项目结构分析

### 2.1 核心文件说明

#### HTML入口文件
- `统一自动化脚本_模板化生成.html` - 主界面，用于上传Excel、选择问卷类型、生成自动化代码

#### JavaScript模块
1. **config.js** - 配置文件
   - 问卷类型配置（5种问卷）
   - API端点配置
   - 默认设置

2. **main.js** - 主应用程序
   - AutomationApp类：应用主控制器
   - 文件上传处理
   - 数据解析和预览
   - 代码生成调度

3. **automation-generator.js** - DOM模式代码生成器（当前使用）
   - 完整的DOM操作实现
   - 支持单日期和多日期批量执行
   - 包含医院创建、联系人创建等功能

4. **automation-generator-optimized.js** - API模式代码生成器（待完善）
   - 基于HTTP API调用的实现
   - 目前仅有基础框架

5. **其他支撑模块**
   - data-processor.js - 数据处理器
   - sheet-selector.js - 工作表选择器
   - ui-manager.js - UI管理器
   - utils.js - 工具函数

## 三、当前DOM模式分析

### 3.1 DOM模式工作流程
1. **数据准备**: 解析Excel数据，过滤指定指派人和日期
2. **页面操作**: 通过contentWindow访问iframe内容
3. **表单填充**: 
   - setInputValue() - 设置输入框值
   - setOptionValue() - 设置选项值（单选/多选）
4. **自动化执行**:
   - start() - 手动执行单个任务
   - automatic() - 自动批量执行
   - automaticByDate() - 按日期顺序执行
   - automaticByName() - 按姓名顺序执行

### 3.2 DOM模式特点
✅ **优点**:
- 实现完整，经过实际测试
- 支持多种执行模式
- 有完善的错误处理和日志
- 支持暂停、恢复、停止控制

❌ **缺点**:
- 依赖页面DOM结构，脆弱性高
- 执行速度受页面加载影响
- 需要保持浏览器窗口活跃

## 四、API模式现状分析

### 4.1 已实现部分
在 `automation-generator-optimized.js` 中已有基础框架：

1. **API配置**:
```javascript
const API_BASE_URL = window.location.origin;
const PROJECT_ID = getProjectIdFromUrl();
const CORP_ID = '1749721838789101';
```

2. **基础函数**:
- createDynamicsSalt() - 获取动态盐值
- generateSign() - 生成签名
- generateQuestionnaireData() - 生成问卷数据
- submitQuestionnaire() - 提交问卷

3. **执行逻辑**:
- createTaskApi() - API模式创建任务
- startApi() - 开始执行
- automaticApi() - 自动执行

### 4.2 存在的问题

#### 🔴 关键问题：
1. **签名算法不完整**
   - 当前使用简化的MD5实现
   - 缺少真实的签名规则（需要分析后端API）

2. **API参数不完整**
   - encryptedText字段的生成逻辑可能不正确
   - 缺少某些必要的请求头或参数

3. **错误处理不完善**
   - 没有处理API限流
   - 缺少重试机制
   - 没有详细的错误日志

4. **功能缺失**
   - 未实现医院创建（API模式）
   - 未实现联系人创建（API模式）
   - 缺少数据验证

## 五、API模式完善方案

### 5.1 需要完善的核心功能

#### 1. 完善签名算法
```javascript
// 需要分析实际的签名规则
function generateSign(data, signkey) {
    // TODO: 实现真实的签名算法
    // 可能需要：
    // 1. 参数按字母排序
    // 2. 拼接成查询字符串
    // 3. 加入时间戳
    // 4. 使用特定的哈希算法
}
```

#### 2. 完善API请求参数
```javascript
// 需要补充完整的请求参数
function generateQuestionnaireData(name, sex, answers, date) {
    // TODO: 添加缺失的字段
    return {
        // 基础字段
        recId: '',
        projectId: PROJECT_ID,
        corpId: CORP_ID,
        
        // 问卷内容
        title: config.title,
        questions: questions.join('#'),
        answers: answers.join('#'),
        
        // 时间相关
        startTime: formatDate(date),
        endTime: calculateEndTime(date),
        
        // 加密和签名
        encryptedText: generateEncryptedText(data),
        sign: generateSign(data, signkey),
        
        // 其他必要字段...
    };
}
```

#### 3. 添加API错误处理
```javascript
async function submitQuestionnaireWithRetry(data, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const result = await submitQuestionnaire(data);
            if (result.success) return result;
            
            // 处理特定错误
            if (result.error === 'RATE_LIMIT') {
                await sleep(Math.pow(2, i) * 1000); // 指数退避
                continue;
            }
            
            throw new Error(result.message);
        } catch (error) {
            if (i === maxRetries - 1) throw error;
            console.log(`重试 ${i + 1}/${maxRetries}...`);
        }
    }
}
```

#### 4. 实现医院和联系人创建API
```javascript
// 创建医院（API模式）
async function createChannelApi(channelName, address) {
    const response = await fetch(`${API_BASE_URL}/lgb/qdkh/save`, {
        method: 'POST',
        headers: getApiHeaders(),
        body: new URLSearchParams({
            channelName: channelName,
            channelType: '医院',
            address: address,
            adcode: getAreaCode(address)
        })
    });
    return response.json();
}

// 创建联系人（API模式）
async function createContactApi(name, sex, type) {
    const response = await fetch(`${API_BASE_URL}/lgb/lxrgl/save`, {
        method: 'POST',
        headers: getApiHeaders(),
        body: new URLSearchParams({
            lxrType: type,
            name: name,
            sex: sex
        })
    });
    return response.json();
}
```

### 5.2 测试和调试策略

#### 1. 网络请求监控
```javascript
// 添加请求拦截器用于调试
function interceptApiCalls() {
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
        console.log('🔵 API请求:', args[0], args[1]);
        const response = await originalFetch.apply(this, args);
        const clonedResponse = response.clone();
        const text = await clonedResponse.text();
        console.log('🟢 API响应:', text);
        return response;
    };
}
```

#### 2. 对比DOM和API模式
```javascript
// 创建对比测试函数
async function compareModesTest(testData) {
    console.log('=== 开始模式对比测试 ===');
    
    // DOM模式测试
    const domStart = Date.now();
    const domResult = await testDomMode(testData);
    const domTime = Date.now() - domStart;
    
    // API模式测试
    const apiStart = Date.now();
    const apiResult = await testApiMode(testData);
    const apiTime = Date.now() - apiStart;
    
    // 输出对比结果
    console.table({
        'DOM模式': { 
            成功率: domResult.successRate, 
            耗时: `${domTime}ms`,
            平均单个: `${domTime/testData.length}ms`
        },
        'API模式': { 
            成功率: apiResult.successRate, 
            耗时: `${apiTime}ms`,
            平均单个: `${apiTime/testData.length}ms`
        }
    });
}
```

### 5.3 实施步骤

#### 第一阶段：分析和准备
1. **抓包分析**: 使用Chrome DevTools分析实际的API请求
2. **参数对比**: 对比DOM模式和API模式的参数差异
3. **签名研究**: 分析签名算法的具体实现

#### 第二阶段：核心功能实现
1. 实现正确的签名算法
2. 补充完整的API参数
3. 添加错误处理和重试机制
4. 实现医院和联系人创建API

#### 第三阶段：优化和测试
1. 添加请求缓存机制
2. 实现批量提交优化
3. 完善日志和调试工具
4. 进行全面的功能测试

#### 第四阶段：文档和部署
1. 编写API模式使用文档
2. 创建测试用例
3. 性能对比报告
4. 部署和监控

## 六、技术建议

### 6.1 代码重构建议
1. **模块化**: 将API模式独立成单独的模块
2. **配置分离**: API配置和DOM配置分开管理
3. **策略模式**: 使用策略模式切换执行模式

### 6.2 性能优化建议
1. **并发控制**: API模式支持并发请求（需控制并发数）
2. **缓存机制**: 缓存盐值和签名，减少重复计算
3. **批量提交**: 支持批量API调用

### 6.3 可维护性建议
1. **单元测试**: 为核心功能添加测试
2. **错误监控**: 集成错误上报机制
3. **版本管理**: 使用Git进行版本控制

## 七、总结

### 当前状态
- ✅ DOM模式：功能完整，可正常使用
- ⚠️ API模式：基础框架已有，核心功能待完善

### 优先级建议
1. **高优先级**: 完善签名算法和API参数
2. **中优先级**: 添加错误处理和重试机制
3. **低优先级**: 性能优化和批量处理

### 预期收益
- **性能提升**: API模式预计可提升3-5倍执行速度
- **稳定性提升**: 不依赖DOM，更加稳定
- **可扩展性**: 易于添加新的问卷类型

## 八、下一步行动计划

1. **立即可做**:
   - 抓包分析真实的API请求
   - 对比DOM模式生成的数据格式
   - 测试现有API模式的基础功能

2. **短期目标**（1-2周）:
   - 完善签名算法
   - 补充API参数
   - 基础功能测试

3. **长期目标**（1个月）:
   - 完整的API模式实现
   - 性能优化
   - 文档完善

---

*文档更新时间: 2025-01-15*
*作者: AI Assistant*