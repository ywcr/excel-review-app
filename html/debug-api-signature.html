<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API签名调试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .debug-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .debug-result { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; width: 200px; }
    </style>
</head>
<body>
    <h1>API签名调试页面</h1>
    <p>专门用于调试API模式的签名生成问题</p>

    <div class="debug-section">
        <div class="debug-title">1. CryptoJS库检查</div>
        <button onclick="checkCryptoJS()">检查CryptoJS</button>
        <div id="cryptoResult" class="debug-result"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">2. 动态盐值获取测试</div>
        <input type="text" id="saltEndpoint" placeholder="盐值端点" value="/lgb/payMerge/createDynamicsSalt?methodName=%2Fxfzwj%2Fadd">
        <button onclick="testSaltGeneration()">测试盐值获取</button>
        <div id="saltResult" class="debug-result"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">3. 签名生成测试</div>
        <input type="text" id="testData" placeholder="测试数据" value='{"name":"测试","sex":"男"}'>
        <input type="text" id="testKey" placeholder="测试密钥" value="testkey123">
        <button onclick="testSignGeneration()">测试签名生成</button>
        <div id="signResult" class="debug-result"></div>
    </div>

    <div class="debug-section">
        <div class="debug-title">4. 完整流程测试</div>
        <button onclick="testFullProcess()">测试完整API流程</button>
        <div id="fullResult" class="debug-result"></div>
    </div>

    <!-- 加载CryptoJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <script>
        const API_BASE_URL = window.location.origin;

        function checkCryptoJS() {
            const result = document.getElementById('cryptoResult');
            let output = [];
            
            output.push('=== CryptoJS库检查 ===');
            output.push(`CryptoJS 对象: ${typeof CryptoJS}`);
            
            if (typeof CryptoJS !== 'undefined') {
                output.push(`HmacSHA256 方法: ${typeof CryptoJS.HmacSHA256}`);
                output.push(`SHA256 方法: ${typeof CryptoJS.SHA256}`);
                
                // 测试基本功能
                try {
                    const testHash = CryptoJS.HmacSHA256('test', 'key').toString();
                    output.push(`基本测试成功: ${testHash}`);
                    result.className = 'debug-result success';
                } catch (error) {
                    output.push(`基本测试失败: ${error.message}`);
                    result.className = 'debug-result error';
                }
            } else {
                output.push('❌ CryptoJS 未加载');
                result.className = 'debug-result error';
            }
            
            result.textContent = output.join('\n');
        }

        async function testSaltGeneration() {
            const result = document.getElementById('saltResult');
            const endpoint = document.getElementById('saltEndpoint').value;
            let output = [];
            
            output.push('=== 动态盐值获取测试 ===');
            output.push(`请求端点: ${API_BASE_URL}${endpoint}`);
            
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'accept': '*/*',
                        'accept-language': 'zh-CN,zh;q=0.9',
                        'x-requested-with': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                });
                
                output.push(`HTTP状态: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                output.push(`响应数据: ${JSON.stringify(data, null, 2)}`);
                
                if (data.code === 0) {
                    output.push('✅ 盐值获取成功');
                    if (data.data) {
                        output.push(`数据结构检查:`);
                        output.push(`  - signkey: ${data.data.signkey ? '存在' : '不存在'}`);
                        output.push(`  - key: ${data.data.key ? '存在' : '不存在'}`);
                        output.push(`  - salt: ${data.data.salt ? '存在' : '不存在'}`);
                        output.push(`  - timestamp: ${data.data.timestamp ? '存在' : '不存在'}`);
                        
                        if (data.data.signkey) {
                            output.push(`  - signkey值: ${data.data.signkey}`);
                        }
                    }
                    result.className = 'debug-result success';
                } else {
                    output.push(`❌ 盐值获取失败: ${data.message}`);
                    result.className = 'debug-result error';
                }
                
            } catch (error) {
                output.push(`❌ 请求失败: ${error.message}`);
                result.className = 'debug-result error';
            }
            
            result.textContent = output.join('\n');
        }

        function testSignGeneration() {
            const result = document.getElementById('signResult');
            const testData = document.getElementById('testData').value;
            const testKey = document.getElementById('testKey').value;
            let output = [];
            
            output.push('=== 签名生成测试 ===');
            output.push(`测试数据: ${testData}`);
            output.push(`测试密钥: ${testKey}`);
            
            try {
                // 使用改进的签名函数
                const signature = generateSignImproved(testData, testKey);
                output.push(`✅ 签名生成成功: ${signature}`);
                result.className = 'debug-result success';
            } catch (error) {
                output.push(`❌ 签名生成失败: ${error.message}`);
                output.push(`错误堆栈: ${error.stack}`);
                result.className = 'debug-result error';
            }
            
            result.textContent = output.join('\n');
        }

        async function testFullProcess() {
            const result = document.getElementById('fullResult');
            let output = [];
            
            output.push('=== 完整API流程测试 ===');
            
            try {
                // 1. 获取动态盐值
                output.push('1. 获取动态盐值...');
                const saltData = await getSaltData();
                output.push(`   ✅ 盐值获取成功: ${JSON.stringify(saltData)}`);
                
                // 2. 准备测试数据
                const testRequestData = {
                    name: '测试用户',
                    sex: '男',
                    date: '2024-11-07',
                    answers: {
                        question_0: '测试答案1',
                        question_1: '测试答案2'
                    }
                };
                
                output.push('2. 准备请求数据...');
                output.push(`   数据: ${JSON.stringify(testRequestData)}`);
                
                // 3. 生成签名
                output.push('3. 生成签名...');
                const dataString = JSON.stringify(testRequestData);
                const signature = generateSignImproved(dataString, saltData.signkey);
                output.push(`   ✅ 签名生成成功: ${signature}`);
                
                output.push('✅ 完整流程测试成功！');
                result.className = 'debug-result success';
                
            } catch (error) {
                output.push(`❌ 流程测试失败: ${error.message}`);
                output.push(`错误堆栈: ${error.stack}`);
                result.className = 'debug-result error';
            }
            
            result.textContent = output.join('\n');
        }

        // 改进的签名生成函数
        function generateSignImproved(data, signkey) {
            if (!data) {
                throw new Error('签名生成失败: data 参数为空');
            }
            if (!signkey) {
                throw new Error('签名生成失败: signkey 参数为空或未定义');
            }
            
            const dataStr = typeof data === 'string' ? data : JSON.stringify(data);
            const keyStr = typeof signkey === 'string' ? signkey : String(signkey);
            
            if (typeof CryptoJS !== 'undefined' && CryptoJS.HmacSHA256) {
                return CryptoJS.HmacSHA256(dataStr, keyStr).toString();
            } else {
                throw new Error('CryptoJS 未加载');
            }
        }

        // 获取盐值数据
        async function getSaltData() {
            const endpoint = document.getElementById('saltEndpoint').value;
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'GET',
                headers: {
                    'accept': '*/*',
                    'accept-language': 'zh-CN,zh;q=0.9',
                    'x-requested-with': 'XMLHttpRequest'
                },
                credentials: 'include'
            });
            
            const result = await response.json();
            if (result.code === 0) {
                if (!result.data.signkey) {
                    if (result.data.key) {
                        result.data.signkey = result.data.key;
                    } else if (result.data.salt) {
                        result.data.signkey = result.data.salt;
                    } else {
                        throw new Error('无法找到有效的签名密钥字段');
                    }
                }
                return result.data;
            } else {
                throw new Error(`获取动态盐值失败: ${result.message}`);
            }
        }

        // 页面加载完成后自动检查
        window.addEventListener('load', function() {
            setTimeout(checkCryptoJS, 500);
        });
    </script>
</body>
</html>
