# 答案字段格式修复总结

## 🔍 问题发现

用户发现答案数据格式不正确：

**当前生成的格式**:
```json
{
  "question_0": "35-45岁",
  "question_1": "政府工作人员",
  "question_2": "等级医院",
  ...
}
```

**实际需要的格式** (基于 `html/zxyy2/zxyy.ltd/lgb/mobile/xfzwj.jsp`):
```html
<input type="radio" name="answer0" title="35-45岁" value="35-45岁">
<input type="radio" name="answer1" title="政府工作人员" value="政府工作人员">
<input type="radio" name="answer2" title="等级医院" value="等级医院">
```

## 🎯 根本原因

通过查看实际的JSP文件发现：
1. **字段名错误**: 实际使用的是 `answer0`, `answer1`, `answer2`，而不是 `question_0`, `question_1`
2. **数据结构不匹配**: 我们生成的对象键名与实际表单字段名不一致
3. **API期望格式**: 后端期望接收 `answer0`, `answer1` 等单独字段，以及一个合并的 `answers` 字段

## 🛠️ 修复方案

### 1. 修改答案数据结构

#### 修复前
```javascript
// 设置问题答案
for (let i = 0; i < 10; i++) {
    const answerFunc = window[`_answer${i}`];
    if (typeof answerFunc === 'function') {
        requestData.answers[`question_${i}`] = answerFunc();  // ❌ 错误的键名
    }
}
```

#### 修复后
```javascript
// 设置问题答案 - 使用数组格式，索引对应answer0, answer1, answer2...
const answersArray = [];
for (let i = 0; i < 10; i++) {
    const answerFunc = window[`_answer${i}`];
    if (typeof answerFunc === 'function') {
        answersArray[i] = answerFunc();  // ✅ 使用数组索引
    }
}
requestData.answers = answersArray;
```

### 2. 修改字段映射逻辑

#### 修复前
```javascript
// 添加单独的answer字段
Object.keys(requestData.answers).forEach((key, index) => {
    ajaxData[`answer${index}`] = requestData.answers[key];  // ❌ 对象遍历
});
```

#### 修复后
```javascript
// 添加单独的answer字段（answer0, answer1, answer2...）
requestData.answers.forEach((answer, index) => {
    if (answer !== undefined) {
        ajaxData[`answer${index}`] = answer;  // ✅ 数组遍历，直接使用索引
    }
});
```

## 📊 数据格式对比

### 修复前的数据结构
```javascript
requestData.answers = {
    "question_0": "35-45岁",
    "question_1": "政府工作人员",
    "question_2": "等级医院"
}

// 发送到API的数据
ajaxData = {
    answers: '{"question_0":"35-45岁","question_1":"政府工作人员",...}',
    answer0: "35-45岁",      // 通过Object.keys遍历得到
    answer1: "政府工作人员",   // 索引可能不准确
    answer2: "等级医院"
}
```

### 修复后的数据结构
```javascript
requestData.answers = [
    "35-45岁",        // index 0
    "政府工作人员",    // index 1  
    "等级医院",       // index 2
    ...
]

// 发送到API的数据
ajaxData = {
    answers: '["35-45岁","政府工作人员","等级医院",...]',
    answer0: "35-45岁",      // 直接使用数组索引
    answer1: "政府工作人员",   // 索引准确对应
    answer2: "等级医院"
}
```

## 🎯 关键改进

### 1. 数据结构一致性
- **修复前**: 使用对象结构，键名不匹配实际表单字段
- **修复后**: 使用数组结构，索引直接对应 `answer0`, `answer1` 等字段

### 2. 字段映射准确性
- **修复前**: 通过 `Object.keys()` 遍历，索引可能不准确
- **修复后**: 直接使用数组索引，确保 `answer${index}` 字段准确对应

### 3. API兼容性
- **修复前**: 生成的字段名与后端期望不匹配
- **修复后**: 完全符合后端API的字段命名规范

## 🚀 预期效果

### 修复前的请求体
```
answers={"question_0":"35-45岁","question_1":"政府工作人员",...}&
answer0=35-45岁&answer1=政府工作人员&...
```

### 修复后的请求体
```
answers=["35-45岁","政府工作人员","等级医院",...]&
answer0=35-45岁&answer1=政府工作人员&answer2=等级医院&...
```

## 📋 验证依据

基于 `html/zxyy2/zxyy.ltd/lgb/mobile/xfzwj.jsp` 的实际表单结构：
- 表单字段名: `name="answer0"`, `name="answer1"`, `name="answer2"`
- 隐藏字段: `<input type="hidden" name="answers">`
- 数据提交: 既需要单独的 `answer0-9` 字段，也需要合并的 `answers` 字段

## 🎯 总结

通过这次修复：

1. **解决了字段名不匹配问题** - 从 `question_0` 改为正确的数组索引对应 `answer0`
2. **统一了数据结构** - 使用数组而不是对象，确保索引准确
3. **提高了API兼容性** - 完全符合后端期望的数据格式
4. **简化了数据处理** - 数组结构更简单，索引映射更直接

现在答案数据应该能正确匹配后端API的期望格式，解决验签失败的问题！
