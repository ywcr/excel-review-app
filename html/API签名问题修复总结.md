# APIç­¾åé—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜åˆ†æ

### é”™è¯¯ä¿¡æ¯
```
âŒ APIåˆ›å»ºå¤±è´¥: æ™¯å½¬å¨£ TypeError: Cannot read properties of undefined (reading 'sigBytes')
    at new init (crypto-js.min.js:1:25096)
    at Object.HmacSHA256 (crypto-js.min.js:1:4015)
    at generateSign (Script snippet #10:292:25)
```

### é—®é¢˜åŸå› 
1. **signkey å‚æ•°ä¸º undefined**: åŠ¨æ€ç›å€¼è·å–æˆåŠŸï¼Œä½†è¿”å›çš„æ•°æ®ç»“æ„ä¸­å¯èƒ½æ²¡æœ‰ `signkey` å­—æ®µ
2. **å‚æ•°ç±»å‹é”™è¯¯**: ä¼ ç»™ `CryptoJS.HmacSHA256` çš„å‚æ•°æ ¼å¼ä¸æ­£ç¡®
3. **ç¼ºå°‘é”™è¯¯å¤„ç†**: åŸå§‹ä»£ç æ²¡æœ‰å¯¹å‚æ•°è¿›è¡ŒéªŒè¯

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. æ”¹è¿›ç­¾åç”Ÿæˆå‡½æ•°
åœ¨ `template-manager.js` ä¸­çš„ `generateSign` å‡½æ•°æ·»åŠ äº†ï¼š

#### å‚æ•°éªŒè¯
```javascript
// å‚æ•°éªŒè¯
if (!data) {
    throw new Error('ç­¾åç”Ÿæˆå¤±è´¥: data å‚æ•°ä¸ºç©º');
}
if (!signkey) {
    throw new Error('ç­¾åç”Ÿæˆå¤±è´¥: signkey å‚æ•°ä¸ºç©ºæˆ–æœªå®šä¹‰');
}
```

#### ç±»å‹è½¬æ¢
```javascript
// ç¡®ä¿å‚æ•°ä¸ºå­—ç¬¦ä¸²ç±»å‹
const dataStr = typeof data === 'string' ? data : JSON.stringify(data);
const keyStr = typeof signkey === 'string' ? signkey : String(signkey);
```

#### è°ƒè¯•æ—¥å¿—
```javascript
console.log('ç­¾åå‚æ•°:', { 
    dataLength: dataStr.length, 
    keyLength: keyStr.length, 
    key: keyStr.substring(0, 10) + '...' 
});
```

#### é”™è¯¯æ•è·
```javascript
try {
    const signature = CryptoJS.HmacSHA256(dataStr, keyStr).toString();
    console.log('ç­¾åç”ŸæˆæˆåŠŸ:', signature.substring(0, 16) + '...');
    return signature;
} catch (error) {
    console.error('CryptoJSç­¾åç”Ÿæˆå¤±è´¥:', error);
    throw new Error(`CryptoJSç­¾åç”Ÿæˆå¤±è´¥: ${error.message}`);
}
```

### 2. æ”¹è¿›åŠ¨æ€ç›å€¼è·å–
åœ¨ `createDynamicsSalt` å‡½æ•°ä¸­æ·»åŠ äº†ï¼š

#### ä½¿ç”¨é…ç½®ç«¯ç‚¹
```javascript
// ä½¿ç”¨é…ç½®ä¸­çš„ç«¯ç‚¹è€Œä¸æ˜¯ç¡¬ç¼–ç 
const response = await fetch(`${API_BASE_URL}${config.saltEndpoint}`, {
```

#### æ•°æ®ç»“æ„éªŒè¯
```javascript
// éªŒè¯è¿”å›çš„æ•°æ®ç»“æ„
if (!result.data) {
    throw new Error('åŠ¨æ€ç›å€¼æ•°æ®ä¸ºç©º');
}
if (!result.data.signkey) {
    console.warn('âš ï¸ è­¦å‘Š: signkey å­—æ®µä¸å­˜åœ¨ï¼Œæ•°æ®ç»“æ„:', result.data);
    // å°è¯•ä»å…¶ä»–å¯èƒ½çš„å­—æ®µè·å–signkey
    if (result.data.key) {
        result.data.signkey = result.data.key;
    } else if (result.data.salt) {
        result.data.signkey = result.data.salt;
    } else {
        throw new Error('æ— æ³•æ‰¾åˆ°æœ‰æ•ˆçš„ç­¾åå¯†é’¥å­—æ®µ');
    }
}
```

### 3. åˆ›å»ºè°ƒè¯•å·¥å…·
åˆ›å»ºäº† `debug-api-signature.html` è°ƒè¯•é¡µé¢ï¼ŒåŒ…å«ï¼š

#### CryptoJSåº“æ£€æŸ¥
- æ£€æŸ¥ CryptoJS æ˜¯å¦æ­£ç¡®åŠ è½½
- æµ‹è¯•åŸºæœ¬çš„ HmacSHA256 åŠŸèƒ½

#### åŠ¨æ€ç›å€¼è·å–æµ‹è¯•
- æµ‹è¯•ç›å€¼ç«¯ç‚¹æ˜¯å¦å¯è®¿é—®
- æ£€æŸ¥è¿”å›æ•°æ®çš„ç»“æ„
- éªŒè¯ signkey å­—æ®µæ˜¯å¦å­˜åœ¨

#### ç­¾åç”Ÿæˆæµ‹è¯•
- ç‹¬ç«‹æµ‹è¯•ç­¾åç”ŸæˆåŠŸèƒ½
- ä½¿ç”¨è‡ªå®šä¹‰æ•°æ®å’Œå¯†é’¥

#### å®Œæ•´æµç¨‹æµ‹è¯•
- æ¨¡æ‹Ÿå®Œæ•´çš„APIè°ƒç”¨æµç¨‹
- ä»ç›å€¼è·å–åˆ°ç­¾åç”Ÿæˆçš„å…¨è¿‡ç¨‹

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. ç«‹å³ä¿®å¤
é‡æ–°ç”Ÿæˆä»£ç åï¼ŒAPIæ¨¡å¼åº”è¯¥èƒ½æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼Œå¸®åŠ©å®šä½å…·ä½“é—®é¢˜ã€‚

### 2. è°ƒè¯•æ­¥éª¤
å¦‚æœä»æœ‰é—®é¢˜ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤è°ƒè¯•ï¼š

1. **æ‰“å¼€è°ƒè¯•é¡µé¢**: `html/debug-api-signature.html`
2. **æ£€æŸ¥CryptoJS**: ç‚¹å‡»"æ£€æŸ¥CryptoJS"ç¡®ä¿åº“æ­£ç¡®åŠ è½½
3. **æµ‹è¯•ç›å€¼è·å–**: ç‚¹å‡»"æµ‹è¯•ç›å€¼è·å–"æŸ¥çœ‹è¿”å›çš„æ•°æ®ç»“æ„
4. **æµ‹è¯•ç­¾åç”Ÿæˆ**: ä½¿ç”¨æµ‹è¯•æ•°æ®éªŒè¯ç­¾ååŠŸèƒ½
5. **å®Œæ•´æµç¨‹æµ‹è¯•**: éªŒè¯æ•´ä¸ªAPIè°ƒç”¨æµç¨‹

### 3. å¸¸è§é—®é¢˜æ’æŸ¥

#### å¦‚æœ signkey ä»ç„¶ä¸º undefined
- æ£€æŸ¥ API ç«¯ç‚¹æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æœåŠ¡å™¨è¿”å›çš„å®é™…æ•°æ®ç»“æ„
- ç¡®è®¤ç™»å½•çŠ¶æ€å’Œæƒé™

#### å¦‚æœ CryptoJS æŠ¥é”™
- ç¡®è®¤ CryptoJS åº“ç‰ˆæœ¬å…¼å®¹æ€§
- æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- å°è¯•ä½¿ç”¨å¤‡ç”¨ç­¾åæ–¹æ³•

#### å¦‚æœå‚æ•°ç±»å‹é”™è¯¯
- æ£€æŸ¥ä¼ å…¥çš„æ•°æ®æ ¼å¼
- ç¡®è®¤ JSON.stringify æ­£å¸¸å·¥ä½œ
- éªŒè¯å­—ç¬¦ä¸²è½¬æ¢æ˜¯å¦æ­£ç¡®

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
âŒ APIåˆ›å»ºå¤±è´¥: æ™¯å½¬å¨£ TypeError: Cannot read properties of undefined (reading 'sigBytes')
```

### ä¿®å¤å
```
ç­¾åå‚æ•°: { dataLength: 156, keyLength: 32, key: "abc123def4..." }
âœ… ç­¾åç”ŸæˆæˆåŠŸ: 8f2a3b4c5d6e7f8g...
âœ… APIåˆ›å»ºæˆåŠŸ: æ™¯å½¬å¨£ (å¥³)
```

æˆ–è€…å¦‚æœä»æœ‰é—®é¢˜ï¼Œä¼šæ˜¾ç¤ºæ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ï¼š
```
âŒ ç­¾åç”Ÿæˆå¤±è´¥: signkey å‚æ•°ä¸ºç©ºæˆ–æœªå®šä¹‰
```

## ğŸ¯ æ€»ç»“

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼š
1. **å¢å¼ºäº†é”™è¯¯å¤„ç†** - æä¾›æ›´æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
2. **æ”¹è¿›äº†å‚æ•°éªŒè¯** - é¿å… undefined å‚æ•°å¯¼è‡´çš„å´©æºƒ
3. **æ·»åŠ äº†è°ƒè¯•å·¥å…·** - ä¾¿äºå¿«é€Ÿå®šä½é—®é¢˜
4. **æé«˜äº†å…¼å®¹æ€§** - æ”¯æŒä¸åŒçš„æ•°æ®ç»“æ„æ ¼å¼

ç°åœ¨APIæ¨¡å¼åº”è¯¥èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œæˆ–è€…è‡³å°‘èƒ½æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å¸®åŠ©è¿›ä¸€æ­¥è°ƒè¯•ã€‚
