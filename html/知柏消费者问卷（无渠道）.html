<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知柏消费者问卷--无渠道</title>
    <style>
        * {
            font-size: 12px;
        }

        .tag {
            font-size: 14px;
            color: red;
            font-weight: bold;
        }

        .dataframe {
            width: 500px;
            height: 300px;
            margin-top: 10px;
        }

        h3 {
            font-size: 18px;
        }
    </style>
    <script lang="javascript" src="https://cc-static-files.oss-cn-hangzhou.aliyuncs.com/xlsx.full.min.js"></script>
</head>

<body>
    <h3>知柏消费者问卷--无渠道</h3>
    <!-- 导入文件 -->
    <div>
        <p class="tag">第一步 选择要导出的excel文件</p>
        <input type="file" name="" id="file" onchange="loadFile(this.files)" />
    </div>
    <!--  -->
    <div>
        <p class="tag">第二步 请输入指派人</p>
        <input type="text" id="zhipairen">
    </div>
    <div>
        <p class="tag">第三步 请填写任务日期</p>
        <input type="text" value="" id="dateInput" placeholder="11.07" />
    </div>
    <div>
        <p class="tag">第四步 点击按钮导出数据</p>
        <button id="handleClickData" onclick="handleData()">数据导出</button><br>
        <textarea id="dataframe" class="dataframe"></textarea>
    </div>
    <script>
        //-------------------1、导入数据-----------------------------
        let sheets = {} //存储导出的excel数据

        //-------------- 导出数据------------------
        function loadFile(files) {
            name = files[0].name.split('.')[0]
            const render = new FileReader()
            render.onload = (e) => {
                const data = XLSX.read(e.target.result, { type: 'binary' })
                for (let i = 0; i < data.SheetNames.length; i++) {
                    const sheetName = data.SheetNames[i];
                    // 将数据转为json对象，第一行会自动识别为列名
                    sheetJson = XLSX.utils.sheet_to_json(data.Sheets[sheetName], { header: 1 });
                    sheets[sheetName] = sheetJson
                }
            }

            render.readAsBinaryString(files[0])
        }



        //-------------------2、解析数据-----------------------------
        function handleData() {
            let runningData = JSON.parse(JSON.stringify(sheets));
            const wenjuan = runningData.知柏消费者问卷?.slice(1) ?? [];

            const all = []
            wenjuan.forEach(item => {
                const [序号, 消费者, 性别,时间, 指派人] = item
                if (指派人 !== zhipairen.value) {
                    return
                }

                // let date = 时间.toString().length === 4 ? 时间.toString() + "0" : 时间.toString()
                
                let dateArr=时间.toString().split('.');
                if(dateArr[0].length!==2){
                    dateArr[0]='0'+dateArr[0]
                }
                if(dateArr[1].length!==2){
                    dateArr[1]= dateArr[1]+'0'
                }

                const date=dateArr[0]+'.'+dateArr[1];

                all.push({ 消费者, 性别 , 指派人, 时间: date })
            })
            console.log(all)
            let nowdate = dateInput.value;

            const tpl = template(JSON.stringify(all), nowdate)
            dataframe.value = tpl
        }

        function template(data, nowdate) {
            return `
            // 使用步骤
                // 1. 解析execl数据，赋值给data
                // 2. 进度调查问卷页面，点创建任务，进入创建任务页面
                // 3. 指定实时日期 date 
                // 4. 执行start()执行脚本

                const data=${data}

                console.log("全部数据",data)
                
                // 实施时间
                let date = '${nowdate}'
                let year = (new Date()).getFullYear();

                // 在创建工单之前，先要创建医院和消费者
                // 1、查询要创建的消费者是否存在
                function getSame(hzName,sex){
                    return new Promise((resolve,reject)=>{
                        $.ajax({
                            url: "/lgb/lxrgl/getMessage",
                            type: "POST",
                            data: {
                                recId:"",
                                nvcVal:"", 
                                empRecId:"", 
                                lxrType:"消费者",
                                name:hzName,
                                sex:sex,
                                remark:""
                            },
                            traditional: true,
                            success: function (res) {
                                setTimeout(function(){
                                    resolve(res)
                                },1500)
                            },
                        });
                    })
                }
                // 2、创建消费者
                function addHuanzhe(hzName,sex){
                    return new Promise((resolve,reject)=>{
                        $.ajax({
                            url:"/lgb/lxrgl/save",
                            type: "POST",
                            data:{
                                recId:"",
                                nvcVal:"", 
                                empRecId:"", 
                                lxrType:"消费者",
                                name:hzName,
                                sex:sex,
                                remark:""
                            },
                            traditional: true,
                            success:function (res) {
                                setTimeout(function(){
                                    resolve()
                                },2000)
                                
                            }
                            
                        })
                    })
                }
                // 3、执行创建消费者任务
                async function startAddHz() {
                    for (let i = 0; i < data.length; i++) {
                        let huanzhename = data[i].消费者
                        let sex = data[i].性别
                        await getSame(huanzhename, sex).then(async (res) => {
                            if (res.code == 0) {
                                await addHuanzhe(huanzhename, sex)
                                console.log(i+"添加成功！"+huanzhename)
                            } else {
                                console.log(i+"消费者已存在！"+huanzhename)
                            }
                        })
                    }
                    console.log("消费者创建完毕，请执行startAddChannel函数创建医院，如已创建请忽略！")
                }
                console.log("执行startAddHz函数创建消费者，如已创建请忽略！")
                console.log("消费者问卷需要先创建消费者和医院，然后关联隐藏的channelAddress")

                // 创建医院开始 接口https://zxyy.ltd/lgb/qdkh/save
               function addAdress(channelName, address) {
                    return new Promise((resolve) => {
                        let adcode = getCode(address)
                        
                        $.ajax({
                            url: "/lgb/qdkh/save",
                            type: "POST",
                            data: {
                                id: "",
                                channelType:"零售渠道档案",
                                adcode,
                                channelName,
                                address
                            },
                            traditional: true,
                            success: function (res) {
                                setTimeout(function () {
                                    resolve(res)
                                }, 2000)
                            }

                        })
                    })
                }

                function getCode(address){
                    for(let i=0;i<city.length;i++){
                        if(address.includes(city[i].name)){
                            for(let j=0;j<city[i].sub.length;j++){
                               if(address.includes(city[i].sub[j].name)){
                                for(let z=0;z<city[i].sub[j].sub.length;z++){
                                    if(address.includes(city[i].sub[j].sub[z].name)){
                                        console.log(city[i].sub[j].sub[z].code)
                                        return city[i].sub[j].sub[z].code
                                    }
                                }
                               }
                            }
                        }
                    }
                }

                async function startAddChannel() {
                    // 数组根据医院去重
                    const uniqueData = data.reduce((acc, obj) => {
                        const found = acc.find(item => item.医院 === obj.医院);
                        if (!found) {
                            acc.push(obj);
                        }
                        return acc;
                    }, []);

                    for (let i = 0; i < uniqueData.length; i++) {
                        await addAdress(uniqueData[i].医院, uniqueData[i].地址).then((res)=>{
                            if(res.code=="-1"){
                                console.log("此渠道名称在系统中已存在！")
                            }else if(res.code=="0"){
                                console.log(i + "添加成功"+uniqueData[i].医院+uniqueData[i].地址)
                            }else{
                                console.log("异常！")
                            }
                        })
                        
                    }
                    console.log("医院创建成功！可执行automatic函数创建工单。如已创建请忽略")
                }
                
                //    创建医院结束


                // 随机性别
                function _sex() {
                    const option = ['男', '女']
                    const index = random(0, option.length - 1)
                    return option[index]
                }
                function randomAnswerByRate(highOption, lowOption, lowRate) {
                    const max = 1 / lowRate
                    const isLow = random(1, max) === max
                    return isLow ? randomAnswer(lowOption) : randomAnswer(highOption)
                }

                function randomAnswer(option) {
                    const index = random(0, option.length - 1)
                    return option[index]
                }

               
               //1、您的年龄？ 
                function _answer0() {
                    const option = ['20岁以下', '20-35岁', '35-45岁','45-60岁','60岁以上']
                    const index = random(0, option.length - 1)
                    return option[index]
                }
                
                // 2、您在什么情况下会去药店买药？ 
                
                function _answer1() {
                    const option = ['身体不适', '自身保健需要', '为亲友购药','咨询用药问题','药店有促销活动']
                    const index = random(0, option.length - 1)
                    return option[index]
                }


                // 3、您选择药店会考虑哪些因素？ 
                function _answer2() {
                    const option = ['离家较近', '口碑更好', '药师服务更好', '药店专业形象', '家人朋友推荐']
                    const index = random(0, option.length - 1)
                    return option[index]
                }

                //4、您买知柏地黄丸时是否会受周围药品广告的影响？  
                function _answer3() {
                    const option = ['会，但是影响不大', '不会', '会，而且影响很大']
                    const index = random(0, option.length - 1)
                    return option[index]
                }
                
                // 5、您选择这家药店购买知柏地黄丸的原因 
                function _answer4(answer2){
                    console.log(answer2)
                    const option = []
                    if (answer2 == '离家较近'){
                        option.push('交通便利')
                    }else if(answer2 == '口碑更好'){
                        option.push('质量好')
                    }else if(answer2 == '药师服务更好'){
                        option.push('服务周到')
                    }else{
                        option.push('价格实惠','药品种类齐全')
                    }
                    const index = random(0, option.length - 1)
                    return option[index]
                }

                //6、在药店购买知柏地黄丸时，药店的哪种行为对你的购药选择影响最大 
                function _answer5() {
                    const option = ['专业知识', '服务态度', '讲解能力','店员形象']
                    const index = random(0, option.length - 1)
                    return option[index]
                }
                

                //7、您在购买知柏地黄丸时，营业人员中医药专业知识如何？  
                function _answer6(){
                    const option = ['很专业', '一般专业', '不专业']
                    const index = random(0, option.length - 1)
                    return option[index]
                }

                //8、在您购买知柏地黄丸时，药师是否向您说明中成药的使用禁忌和注意事项？ 
                function _answer7(){
                    const option=['每次都是','多数','偶尔','从不']
                    const index = random(0, option.length - 1)
                    return option[index]
                }

                //9、您是否满意药店推荐给您的知柏地黄丸的药物效果？ 
                function _answer8(){
                    return randomAnswerByRate(['是'],['否'],0.18)
                }


                // function getValueFromIframe(name) {
                //     return document.querySelector('#ssfwIframe').contentWindow.document.querySelector(\`input[name=\${name}]\`).value
                // }

                // dom查找值
                function getValueFromIframe(name) {
                    return contentWindow.document.querySelector(\`input[name=\${name}]\`)
                }

                const contentWindow = document.querySelector('#ssfwIframe')?.contentWindow ?? window
                // 所有问题
                const questions = getValueFromIframe('questions')
                // 所有问题的选项
                const options = getValueFromIframe('options')
                // 所有问题的类型（单选 多选）
                const types = getValueFromIframe('types')

                function setInputValue(name, value) {
                    const items = contentWindow.document.querySelectorAll('.main')[0].querySelectorAll('.layui-form-item')
                    for (let item of items) {
                        const label = item.querySelector('label').innerText.replace('*', '').replaceAll(' ', '');
                        if (label !== name) {
                            continue
                        }
                        // item.querySelectorAll('input').forEach(input => {
                        //     input.value = value
                        // })
                        const list=item.querySelectorAll('input');

                        list[list.length-1].value=value;
                        return
                    }
                    console.error(\`未找到\${name}\`)
                }
                function setOptionValue(index, values) {
                    const items = contentWindow.document.querySelectorAll('.main')[1].querySelectorAll('.layui-form-item')
                    if (!Array.isArray(values)) {
                        values = [values]
                    }
                    values.forEach(val=>{
                        items[index].querySelector(\`input[value="\${val}"]\`).nextElementSibling.click()
                    }
                    )
                }



                function createTask(name, sex) {
                

                    setInputValue('实施日期', year + "-" + date.replace(/\\./g, '-'))
                    setInputValue('消费者姓名', name)
                    setInputValue('性别', sex)
                    
                    let answer2 = _answer2()
                    setOptionValue(0, _answer0())
                    setOptionValue(1, _answer1())
                    setOptionValue(2, answer2)
                    setOptionValue(3, _answer3())
                    setOptionValue(4, _answer4(answer2))
                    setOptionValue(5, _answer5())
                    setOptionValue(6, _answer6())
                    setOptionValue(7, _answer7())
                    setOptionValue(8, _answer8())
                    // setOptionValue(9, _answer9())
                    // setOptionValue(10, _answer10())

                    setTimeout(function(){
                        contentWindow.document.querySelector('.btn-over button').click()
                    },5000)

                    
                }

                var exec_data = data.filter(item=>{
                    const {消费者, 时间} = item
                    return date.endsWith(时间)
                }
                )
                console.log(\`\${date}待执行数据\`, exec_data);

                // 开始执行任务
                var count = 0
                var i = 0
                async function start(num=10000) {
                    const {消费者,性别, 时间} = exec_data[i]
                    // if (count >= num) {
                    //     console.log("任务完成！")
                    //     return
                    // }
                    console.log(\`开始填表单:\${i}\`, 消费者, 性别, exec_data[i])
                    count++
                    i++
                    createTask(消费者,性别)
                    console.log('表单填写完成')
                    if(i>=exec_data.length){
                        console.log("任务完成！")
                        return
                    }
                }

                
                // 随机生成数
                function random(min, max) {
                    return Math.floor(Math.random() * (max - min + 1) + min)
                }
                var num=0;
                function automatic(){
                    num++
                    if(num>100){
                        console.log("任务完成！")
                        return
                    }
                    start()
                    setTimeout(function(){
                        automatic() 
                    },12650)
                }

            `
        }
    </script>
</body>

</html>