<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>精灵蜂统一自动化脚本 - 超级好用版 (v2)</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* ========== V2 布局增强 ========== */
      body { padding: 16px; }
      .v2-container { padding: 0; }
      .v2-shell {
        display: grid;
        grid-template-columns: 320px minmax(0, 1fr);
        align-items: start;
        gap: 16px;
      }
      .v2-sidebar {
        position: sticky;
        top: 12px;
        align-self: start;
        max-height: calc(100vh - 24px);
        overflow: auto;
        display: grid;
        gap: 16px;
      }
      .v2-main {
        display: grid;
        gap: 16px;
      }
      .v2-card {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 10px;
        padding: 16px;
      }
      .v2-section-title {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .v2-sticky-actions {
        position: sticky;
        top: 0;
        z-index: 50;
        background: #fff;
        border: 1px solid #ffecb5;
        border-left: 4px solid #f57c00;
        box-shadow: 0 4px 16px rgba(0,0,0,0.06);
        border-radius: 10px;
        padding: 10px 12px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px 16px;
      }
      .v2-sticky-actions h3 {
        margin: 0;
        font-size: 14px;
        color: #f57c00;
      }
      .v2-sticky-actions .spacer { flex: 1; }
      .v2-grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      @media (max-width: 1080px) {
        .v2-shell { grid-template-columns: 1fr; }
        .v2-grid-2 { grid-template-columns: 1fr; }
      }
      .v2-muted { color: #6c757d; font-size: 12px; }
      .v2-usage-note {
        background: #e3f2fd;
        border: 1px solid #b6e0fe;
        padding: 10px 12px;
        border-radius: 8px;
        color: #0d6efd;
      }
      /* 让代码结果更醒目并独占行宽 */
      #questionnaireCreationResults .code-result { margin-top: 10px; }
      /* 让日志可折叠的感觉（保持原ID与样式） */
      .log-container h3 { display: flex; justify-content: space-between; align-items: center; }
      .log-container h3 button { border: none; background: #f1f3f5; border-radius: 6px; padding: 4px 8px; cursor: pointer; }
      .log-container h3 button:hover { background: #e9ecef; }

      /* 防止横向滚动 */
      html, body { overflow-x: hidden; }

      /* 修复代码头部标题过长撑宽 */
      .code-header { display: flex; align-items: center; gap: 12px; overflow: hidden; }
      .code-header h4 { flex: 1 1 auto; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .copy-btn { flex-shrink: 0; }

      /* 折叠面板样式 */
      details.auto-features > summary.v2-section-title { cursor: pointer; user-select: none; }
      details.auto-features > summary.v2-section-title::after { content: '▼'; font-size: 12px; color: #6c757d; margin-left: 6px; transition: transform .2s; }
      details.auto-features[open] > summary.v2-section-title::after { transform: rotate(180deg); }
    </style>
  </head>

  <body>
    <div class="container v2-container">
      <h1>🤖 精灵蜂统一自动化脚本 - 超级好用版 (v2)</h1>

      <div class="v2-shell">
        <!-- 侧边栏：模式、功能、类型、上传 -->
        <aside class="v2-sidebar">
          <!-- 执行模式 -->
          <div class="v2-card api-config">
            <div class="v2-section-title">⚙️ 执行模式</div>
            <div class="api-toggle">
              <div class="mode-switch" role="group" aria-label="选择执行模式">
                <label>
                  <input type="radio" name="execMode" value="dom" checked />
                  <span>🧩 DOM模式</span>
                </label>
                <label style="margin-left: 12px;">
                  <input type="radio" name="execMode" value="api" />
                  <span>🚀 API模式</span>
                </label>
              </div>
              <div class="api-info" id="modeHint" style="margin-top: 6px">
                ✅ DOM模式：通过页面操作实现自动化，更稳定
              </div>
            </div>
          </div>


          <!-- 问卷类型选择 -->
          <div class="v2-card questionnaire-selector">
            <h3 class="v2-section-title">📋 选择问卷类型</h3>
            <div class="questionnaire-types" id="questionnaireTypes">
              <!-- 问卷类型将通过JavaScript动态生成 -->
            </div>
          </div>

          <!-- 文件上传 -->
          <div class="v2-card">
            <h3 class="v2-section-title">📁 导入数据</h3>
            <div class="file-upload" id="fileUpload">
              <p style="margin: 0">📄 拖拽 Excel 文件到此处，或点击选择文件</p>
              <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" />
            </div>
            <p class="v2-muted" style="margin-top:8px;">支持 .xlsx / .xls | 解析将自动进行</p>
          </div>

          <!-- 高级选项（折叠，移动到底部） -->
          <details class="v2-card auto-features" id="advancedOptions">
            <summary class="v2-section-title">🛠️ 高级选项</summary>
            <div style="margin-top:12px;">
              <div class="feature-toggle">
                <label>
                  <input type="checkbox" id="autoNextDate" checked />
                  <span>📅 自动切换日期</span>
                </label>
                <div class="feature-info">
                  ✅ 当前日期任务完成后自动切换到下一个日期<br />
                  ⚠️ 关闭后需要手动选择日期
                </div>
              </div>
              <div class="feature-toggle">
                <label>
                  <input type="checkbox" id="autoValidation" checked />
                  <span>🔍 自动数据验证</span>
                </label>
                <div class="feature-info">
                  ✅ 任务完成后自动验证是否有遗漏<br />
                  ✅ 发现遗漏时自动补充创建
                </div>
              </div>
              <div class="feature-toggle" style="margin-bottom: 0;">
                <label>
                  <input type="checkbox" id="consoleSnippetMode" checked />
                  <span>📦 控制台代码片段模式</span>
                </label>
                <div class="feature-info">
                  ✅ 生成适合Chrome DevTools Snippets的代码格式<br />
                  ✅ 自动命名为指派人名称，方便管理
                </div>
              </div>
            </div>
          </details>
        </aside>

        <!-- 主内容 -->
        <main class="v2-main">
          <!-- 粘顶操作条（生成 + 摘要） -->
          <div class="v2-sticky-actions" id="generationButtons" style="display:none;">
            <h3>🚀 生成自动化代码</h3>
            <div class="validation-buttons">
              <button class="validation-btn primary" id="createQuestionnairesBtn" disabled>
                📝 生成并复制 当前日期代码
              </button>
              <button class="validation-btn secondary" id="createAllQuestionnairesBtn" disabled>
                📊 生成并复制 全部日期代码
              </button>
            </div>
            <span class="spacer"></span>
            <p id="dataSummary" class="v2-muted" style="display:none; margin:0;"></p>
          </div>


          <!-- 指派人 / 日期 双栏布局 -->
          <div class="v2-grid-2">
            <div class="v2-card assignee-management" id="assigneeManagement" style="display:none;">
              <h3 class="v2-section-title">👥 指派人管理</h3>
              <div class="assignee-list" id="assigneeList"></div>
            </div>
            <div class="v2-card date-management" id="dateManagement" style="display:none;">
              <h3 class="v2-section-title">📅 <span id="selectedAssigneeName">选择指派人</span> 的日期管理</h3>
              <div class="date-status" id="dateStatus">
                <p style="text-align:center; color:#6c757d; padding: 12px; margin: 0;">👆 请先点击左侧指派人查看其日期</p>
              </div>
            </div>
          </div>

          <!-- 代码生成结果 -->
          <div class="v2-card questionnaire-creation-section" id="questionnaireCreationSection" style="display:none;">
            <h3 class="v2-section-title">📦 生成结果</h3>
            <div id="questionnaireCreationResults" style="margin-top: 10px;"></div>
            <div class="v2-usage-note" id="usageInstructions" style="display:none; margin-top: 12px;">
              <strong>📖 使用说明：</strong>
              <ol style="margin: 8px 0 0 18px;">
                <li>在上方选择 "DOM模式" 或 "API模式"</li>
                <li>点击粘顶操作条中的 "📋 复制代码" 按钮</li>
                <li>打开问卷页面，按 F12 打开开发者工具</li>
                <li>粘贴代码并执行，根据提示调用相应函数</li>
              </ol>
              <div style="margin-top: 10px;" class="v2-muted">
                <div><strong>🔧 模式说明：</strong> DOM模式更稳健；API模式更高速。</div>
              </div>
            </div>
          </div>

          <!-- 数据验证（说明） -->
          <div class="v2-card validation-section" id="validationSection" style="display:none;">
            <h3 class="v2-section-title">🔍 数据验证工具</h3>
            <p class="v2-muted" style="margin-top: 0;">这些命令已集成在生成代码中，执行自动化后可在控制台使用：</p>
            <div style="background:#f8f9fa; padding:12px; border-radius:8px;">
              <code style="display:block; margin:4px 0;">validateData() - 验证当前数据集创建情况并给出缺失列表</code>
              <code style="display:block; margin:4px 0;">showMissing() - 以表格和 JSON 形式显示缺失项</code>
              <code style="display:block; margin:4px 0;">updateWithMissing() - 自动补充创建缺失项（随后会再次验证）</code>
            </div>
          </div>

          <!-- 日志区域 -->
          <div class="v2-card log-container">
            <h3>📝 操作日志 <button type="button" onclick="(function(b){ const box = document.getElementById('logContainer'); if(!box) return; const s = getComputedStyle(box); box.style.display = (s.display==='none'?'block':'none'); b.textContent = (s.display==='none'?'收起日志':'展开日志'); })(this)">收起日志</button></h3>
            <div id="logContainer"></div>
          </div>
        </main>
      </div>
    </div>

    <!-- Sheet选择模态框（保持不变，确保逻辑可用） -->
    <div id="sheetModal" class="sheet-modal" style="display: none">
      <div class="sheet-modal-content">
        <h3>📋 选择Excel工作表</h3>

        <div class="match-info" id="matchInfo">
          <h4>🔍 匹配结果</h4>
          <p id="matchMessage"></p>
        </div>

        <div class="sheet-selection">
          <div class="sheet-list" id="sheetList">
            <!-- Sheet列表将通过JavaScript动态生成 -->
          </div>

          <div class="sheet-preview" id="sheetPreview" style="display: none">
            <h4>📊 数据预览</h4>
            <div id="previewContent"></div>
          </div>

          <div class="remember-choice">
            <label>
              <input type="checkbox" id="rememberChoice" />
              <span>记住我的选择（相同问卷类型时自动使用）</span>
            </label>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="modal-btn secondary" onclick="closeSheetModal()">取消</button>
          <button class="modal-btn primary" id="confirmSheetBtn" onclick="confirmSheetSelection()" disabled>确认选择</button>
        </div>
      </div>
    </div>

    <!-- 第三方库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <!-- 模块化脚本（保持与原页面一致的加载顺序） -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/data-processor.js"></script>
    <script src="js/ui-manager.js"></script>
    <script src="js/sheet-selector.js"></script>
    <!-- <script src="js/automation-generator.js"></script> -->
    <!-- <script src="js/automation-generator-optimized.js"></script> -->
    <script src="js/automation-generator-enhanced.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>
