# ğŸ” ç”¨æˆ·è®¤è¯ç³»ç»Ÿå®Œæ•´éœ€æ±‚æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®èƒŒæ™¯

Excel éªŒè¯åº”ç”¨éœ€è¦ç”¨æˆ·è®¤è¯ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§ç™»å½•æ–¹å¼ï¼Œå®ç°ç”¨æˆ·ä¼šè¯ç®¡ç†å’Œå•ç‚¹ç™»å½•åŠŸèƒ½ã€‚

### æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 14 (App Router)
- **è®¤è¯**: JWT + æ–‡ä»¶å­˜å‚¨
- **ç™»å½•æ–¹å¼**: æ‰‹æœºéªŒè¯ç ã€å¾®ä¿¡ã€æ”¯ä»˜å®
- **å­˜å‚¨**: æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ (JSON)

## ğŸ¯ åŠŸèƒ½éœ€æ±‚

### 1. ç”¨æˆ·è®¤è¯åŠŸèƒ½

#### 1.1 ç™»å½•æ–¹å¼

- **æ‰‹æœºéªŒè¯ç ç™»å½•** (ä¸»è¦æ–¹å¼)

  - æ”¯æŒä¸­å›½å¤§é™†æ‰‹æœºå·æ ¼å¼éªŒè¯
  - 6 ä½æ•°å­—éªŒè¯ç 
  - éªŒè¯ç æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿ
  - é˜²åˆ·æœºåˆ¶ï¼šåŒä¸€æ‰‹æœºå· 1 åˆ†é’Ÿå†…æœ€å¤šå‘é€ 1 æ¬¡

- **å¾®ä¿¡ç™»å½•** (å¯é€‰)

  - å¾®ä¿¡æ‰«ç ç™»å½•
  - è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - ç»‘å®šæ‰‹æœºå·

- **æ”¯ä»˜å®ç™»å½•** (å¯é€‰)
  - æ”¯ä»˜å®æˆæƒç™»å½•
  - è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
  - ç»‘å®šæ‰‹æœºå·

#### 1.2 ç”¨æˆ·ä¿¡æ¯ç®¡ç†

- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼šIDã€æ‰‹æœºå·ã€æ˜µç§°ã€å¤´åƒ
- ç™»å½•è®°å½•ï¼šåˆ›å»ºæ—¶é—´ã€æœ€åç™»å½•æ—¶é—´
- ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šä¿¡æ¯

#### 1.3 ä¼šè¯ç®¡ç†

- JWT Token è®¤è¯
- Token æœ‰æ•ˆæœŸ 7 å¤©
- è‡ªåŠ¨ç»­æœŸæœºåˆ¶
- å®‰å…¨é€€å‡ºç™»å½•

### 2. å•ç‚¹ç™»å½•(SSO)åŠŸèƒ½

#### 2.1 æ ¸å¿ƒéœ€æ±‚

- **é—®é¢˜**: ç”¨æˆ·åœ¨æ–°æµè§ˆå™¨ç™»å½•æ—¶ï¼Œæ—§æµè§ˆå™¨ä¸ä¼šè‡ªåŠ¨é€€å‡º
- **è§£å†³æ–¹æ¡ˆ**: Token ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶
- **ç”¨æˆ·é€‰æ‹©**: ç™»å½•æ—¶å¯é€‰æ‹©æ˜¯å¦å¼ºåˆ¶é€€å‡ºå…¶ä»–è®¾å¤‡

#### 2.2 å®ç°ç­–ç•¥

- Token ç‰ˆæœ¬å·æœºåˆ¶
- æ™ºèƒ½æ£€æµ‹æ´»è·ƒä¼šè¯
- ç”¨æˆ·å‹å¥½çš„æç¤ºç•Œé¢
- å¼ºåˆ¶é€€å‡ºç¡®è®¤æœºåˆ¶

### 3. å®‰å…¨è¦æ±‚

#### 3.1 æ•°æ®å®‰å…¨

- æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
- JWT Secret å®‰å…¨ç®¡ç†
- é˜²æ­¢ CSRF æ”»å‡»
- XSS é˜²æŠ¤

#### 3.2 è®¿é—®æ§åˆ¶

- è·¯ç”±çº§åˆ«çš„è®¤è¯ä¿æŠ¤
- API æ¥å£æƒé™éªŒè¯
- ä¼šè¯è¶…æ—¶å¤„ç†

## ğŸ—ï¸ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯é¡µé¢      â”‚    â”‚   APIè·¯ç”±       â”‚    â”‚   æ–‡ä»¶å­˜å‚¨      â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ â”œâ”€ç™»å½•é¡µé¢      â”‚â—„â”€â”€â–ºâ”‚ â”œâ”€è®¤è¯API       â”‚â—„â”€â”€â–ºâ”‚ â”œâ”€users.json    â”‚
â”‚ â”œâ”€ç”¨æˆ·ä¸­å¿ƒ      â”‚    â”‚ â”œâ”€éªŒè¯ç API     â”‚    â”‚ â”œâ”€sessions.json â”‚
â”‚ â””â”€å—ä¿æŠ¤é¡µé¢    â”‚    â”‚ â””â”€ç¬¬ä¸‰æ–¹ç™»å½•API â”‚    â”‚ â””â”€codes.json    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                       â–²
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              JWT Token è®¤è¯
```

### 2. æ•°æ®æ¨¡å‹è®¾è®¡

#### 2.1 ç”¨æˆ·æ•°æ®ç»“æ„

```typescript
interface User {
  id: string; // ç”¨æˆ·å”¯ä¸€ID
  phone?: string; // æ‰‹æœºå·
  email?: string; // é‚®ç®±
  name?: string; // ç”¨æˆ·æ˜µç§°
  avatar?: string; // å¤´åƒURL
  provider?: "phone" | "wechat" | "alipay"; // ç™»å½•æ–¹å¼
  providerAccountId?: string; // ç¬¬ä¸‰æ–¹è´¦å·ID
  tokenVersion: number; // Tokenç‰ˆæœ¬å·(SSOå…³é”®)
  createdAt: string; // åˆ›å»ºæ—¶é—´
  lastLoginAt: string; // æœ€åç™»å½•æ—¶é—´
}
```

#### 2.2 JWT è½½è·ç»“æ„

```typescript
interface JWTPayload {
  userId: string; // ç”¨æˆ·ID
  phone?: string; // æ‰‹æœºå·
  name?: string; // ç”¨æˆ·å
  tokenVersion: number; // Tokenç‰ˆæœ¬å·
  iat: number; // ç­¾å‘æ—¶é—´
  exp: number; // è¿‡æœŸæ—¶é—´
}
```

#### 2.3 éªŒè¯ç æ•°æ®ç»“æ„

```typescript
interface VerificationCode {
  phone: string; // æ‰‹æœºå·
  code: string; // éªŒè¯ç 
  createdAt: string; // åˆ›å»ºæ—¶é—´
  expiresAt: string; // è¿‡æœŸæ—¶é—´
  attempts: number; // å°è¯•æ¬¡æ•°
}
```

### 3. æ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ

#### 3.1 å­˜å‚¨ç»“æ„

```
data/
â”œâ”€â”€ users.json              # ç”¨æˆ·æ•°æ®
â”œâ”€â”€ verification-codes.json # éªŒè¯ç æ•°æ®
â”œâ”€â”€ sessions.json           # ä¼šè¯è®°å½•(å¯é€‰)
â””â”€â”€ validation-records.json # éªŒè¯è®°å½•(ç°æœ‰)
```

#### 3.2 å¹¶å‘å®‰å…¨æœºåˆ¶

```typescript
// æ–‡ä»¶é”æœºåˆ¶
const locks = new Map<string, Promise<any>>();

async function withFileLock<T>(
  filePath: string,
  operation: () => Promise<T>
): Promise<T> {
  // å®ç°æ–‡ä»¶çº§åˆ«çš„äº’æ–¥é”
}
```

### 4. API æ¥å£è®¾è®¡

#### 4.1 è®¤è¯ç›¸å…³æ¥å£

```
POST /api/auth/send-code     # å‘é€éªŒè¯ç 
POST /api/auth/signin        # ç”¨æˆ·ç™»å½•
POST /api/auth/signout       # ç”¨æˆ·é€€å‡º
GET  /api/auth/me           # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
POST /api/auth/check-session # æ£€æŸ¥æ´»è·ƒä¼šè¯
```

#### 4.2 ç¬¬ä¸‰æ–¹ç™»å½•æ¥å£

```
GET  /api/auth/wechat       # å¾®ä¿¡ç™»å½•
GET  /api/auth/alipay       # æ”¯ä»˜å®ç™»å½•
POST /api/auth/bind-phone   # ç»‘å®šæ‰‹æœºå·
```

### 5. å‰ç«¯é¡µé¢ç»“æ„

#### 5.1 é¡µé¢è·¯ç”±

```
/auth/signin                # ç™»å½•é¡µé¢
/auth/profile              # ç”¨æˆ·ä¸­å¿ƒ
/auth/bind-phone           # ç»‘å®šæ‰‹æœºå·
/                          # ä¸»é¡µ(éœ€è¦è®¤è¯)
/frontend-validation       # å‰ç«¯éªŒè¯(éœ€è¦è®¤è¯)
```

#### 5.2 ç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ signin/page.tsx        # ç™»å½•é¡µé¢
â”‚   â”‚   â”œâ”€â”€ profile/page.tsx       # ç”¨æˆ·ä¸­å¿ƒ
â”‚   â”‚   â””â”€â”€ bind-phone/page.tsx    # ç»‘å®šæ‰‹æœºå·
â”‚   â”œâ”€â”€ api/auth/                  # è®¤è¯API
â”‚   â””â”€â”€ (protected)/               # å—ä¿æŠ¤çš„é¡µé¢
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ LoginForm.tsx          # ç™»å½•è¡¨å•
â”‚   â”‚   â”œâ”€â”€ PhoneInput.tsx         # æ‰‹æœºå·è¾“å…¥
â”‚   â”‚   â”œâ”€â”€ CodeInput.tsx          # éªŒè¯ç è¾“å…¥
â”‚   â”‚   â””â”€â”€ SSOOptions.tsx         # å•ç‚¹ç™»å½•é€‰é¡¹
â”‚   â””â”€â”€ layout/
â”‚       â”œâ”€â”€ AuthGuard.tsx          # è®¤è¯å®ˆå«
â”‚       â””â”€â”€ UserMenu.tsx           # ç”¨æˆ·èœå•
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAuth.tsx                # è®¤è¯Hook
â”‚   â””â”€â”€ useLocalStorage.tsx        # æœ¬åœ°å­˜å‚¨Hook
â””â”€â”€ lib/
    â”œâ”€â”€ auth.ts                    # è®¤è¯å·¥å…·
    â”œâ”€â”€ jwt.ts                     # JWTå·¥å…·
    â”œâ”€â”€ fileStorage.ts             # æ–‡ä»¶å­˜å‚¨
    â”œâ”€â”€ fileLock.ts                # æ–‡ä»¶é”
    â””â”€â”€ validators.ts              # éªŒè¯å™¨
```

## ğŸ“ è¯¦ç»†å®ç°ä»»åŠ¡

### Phase 1: åŸºç¡€è®¤è¯ç³»ç»Ÿ (ä¼˜å…ˆçº§: ğŸ”¥ é«˜)

#### 1.1 æ–‡ä»¶å­˜å‚¨åŸºç¡€è®¾æ–½

**ä»»åŠ¡**: åˆ›å»ºç”¨æˆ·æ•°æ®å­˜å‚¨å’Œç®¡ç†ç³»ç»Ÿ
**æ–‡ä»¶**: `src/lib/fileStorage.ts`
**åŠŸèƒ½**:

- [ ] å®ç° `User` æ¥å£å®šä¹‰
- [ ] åˆ›å»º `UserStorage` ç±»
- [ ] å®ç°ç”¨æˆ· CRUD æ“ä½œ
- [ ] æ·»åŠ  `tokenVersion` å­—æ®µæ”¯æŒ
- [ ] å®ç°æ–‡ä»¶è¯»å†™å®‰å…¨æœºåˆ¶

**ä»£ç ç¤ºä¾‹**:

```typescript
export class UserStorage {
  static async create(
    userData: Omit<User, "id" | "createdAt" | "lastLoginAt" | "tokenVersion">
  ): Promise<User>;
  static async findById(id: string): Promise<User | null>;
  static async findByPhone(phone: string): Promise<User | null>;
  static async update(id: string, updates: Partial<User>): Promise<User | null>;
  static async invalidateAllTokens(userId: string): Promise<void>;
}
```

#### 1.2 JWT è®¤è¯ç³»ç»Ÿ

**ä»»åŠ¡**: å®ç° JWT token ç”Ÿæˆå’ŒéªŒè¯
**æ–‡ä»¶**: `src/lib/jwt.ts`
**åŠŸèƒ½**:

- [ ] JWT token ç”Ÿæˆ (`signToken`)
- [ ] JWT token éªŒè¯ (`verifyToken`)
- [ ] Token ç‰ˆæœ¬æ§åˆ¶æ”¯æŒ
- [ ] å®‰å…¨é…ç½®ç®¡ç†

**ä»£ç ç¤ºä¾‹**:

```typescript
export async function signToken(
  payload: Omit<JWTPayload, "iat" | "exp">
): Promise<string>;
export async function verifyToken(token: string): Promise<JWTPayload | null>;
```

#### 1.3 éªŒè¯ç ç³»ç»Ÿ

**ä»»åŠ¡**: å®ç°æ‰‹æœºéªŒè¯ç å‘é€å’ŒéªŒè¯
**æ–‡ä»¶**: `src/lib/verificationCode.ts`
**åŠŸèƒ½**:

- [ ] éªŒè¯ç ç”Ÿæˆå’Œå­˜å‚¨
- [ ] éªŒè¯ç éªŒè¯é€»è¾‘
- [ ] é˜²åˆ·æœºåˆ¶
- [ ] è¿‡æœŸæ¸…ç†æœºåˆ¶

**ä»£ç ç¤ºä¾‹**:

```typescript
export class VerificationCodeService {
  static async sendCode(
    phone: string
  ): Promise<{ success: boolean; message: string }>;
  static async verifyCode(phone: string, code: string): Promise<boolean>;
  static async cleanExpiredCodes(): Promise<void>;
}
```

### Phase 2: API æ¥å£å®ç° (ä¼˜å…ˆçº§: ğŸ”¥ é«˜)

#### 2.1 å‘é€éªŒè¯ç æ¥å£

**ä»»åŠ¡**: å®ç°éªŒè¯ç å‘é€ API
**æ–‡ä»¶**: `src/app/api/auth/send-code/route.ts`
**åŠŸèƒ½**:

- [ ] æ‰‹æœºå·æ ¼å¼éªŒè¯
- [ ] é˜²åˆ·æœºåˆ¶æ£€æŸ¥
- [ ] éªŒè¯ç ç”Ÿæˆå’Œå‘é€
- [ ] é”™è¯¯å¤„ç†å’Œå“åº”

**æ¥å£è§„èŒƒ**:

```typescript
// POST /api/auth/send-code
Request: { phone: string }
Response: {
  success: boolean
  message: string
  cooldown?: number  // å‰©ä½™å†·å´æ—¶é—´(ç§’)
}
```

#### 2.2 ç”¨æˆ·ç™»å½•æ¥å£

**ä»»åŠ¡**: å®ç°ç”¨æˆ·ç™»å½• API
**æ–‡ä»¶**: `src/app/api/auth/signin/route.ts`
**åŠŸèƒ½**:

- [ ] éªŒè¯ç éªŒè¯
- [ ] ç”¨æˆ·åˆ›å»º/æŸ¥æ‰¾
- [ ] JWT token ç”Ÿæˆ
- [ ] SSO å¼ºåˆ¶é€€å‡ºé€»è¾‘
- [ ] Cookie è®¾ç½®

**æ¥å£è§„èŒƒ**:

```typescript
// POST /api/auth/signin
Request: {
  phone: string
  code: string
  forceLogout?: boolean  // æ˜¯å¦å¼ºåˆ¶é€€å‡ºå…¶ä»–è®¾å¤‡
}
Response: {
  success: boolean
  user: {
    id: string
    phone: string
    name?: string
    avatar?: string
  }
  forcedLogout?: boolean  // æ˜¯å¦å¼ºåˆ¶é€€å‡ºäº†å…¶ä»–è®¾å¤‡
}
```

#### 2.3 ç”¨æˆ·ä¿¡æ¯æ¥å£

**ä»»åŠ¡**: å®ç°è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ API
**æ–‡ä»¶**: `src/app/api/auth/me/route.ts`
**åŠŸèƒ½**:

- [ ] Token éªŒè¯
- [ ] ç”¨æˆ·ä¿¡æ¯è¿”å›
- [ ] é”™è¯¯å¤„ç†

#### 2.4 é€€å‡ºç™»å½•æ¥å£

**ä»»åŠ¡**: å®ç°ç”¨æˆ·é€€å‡º API
**æ–‡ä»¶**: `src/app/api/auth/signout/route.ts`
**åŠŸèƒ½**:

- [ ] æ¸…é™¤ Cookie
- [ ] å¯é€‰çš„ token å¤±æ•ˆ
- [ ] å“åº”å¤„ç†

#### 2.5 ä¼šè¯æ£€æŸ¥æ¥å£

**ä»»åŠ¡**: å®ç°æ´»è·ƒä¼šè¯æ£€æŸ¥ API
**æ–‡ä»¶**: `src/app/api/auth/check-session/route.ts`
**åŠŸèƒ½**:

- [ ] æ£€æŸ¥ç”¨æˆ·æœ€è¿‘ç™»å½•æ´»åŠ¨
- [ ] è¿”å›ä¼šè¯çŠ¶æ€ä¿¡æ¯
- [ ] æ”¯æŒ SSO å†³ç­–

### Phase 3: å‰ç«¯è®¤è¯ç•Œé¢ (ä¼˜å…ˆçº§: ğŸ”¥ é«˜)

#### 3.1 ç™»å½•é¡µé¢

**ä»»åŠ¡**: åˆ›å»ºç”¨æˆ·ç™»å½•ç•Œé¢
**æ–‡ä»¶**: `src/app/auth/signin/page.tsx`
**åŠŸèƒ½**:

- [ ] æ‰‹æœºå·è¾“å…¥å’ŒéªŒè¯
- [ ] éªŒè¯ç å‘é€å’Œè¾“å…¥
- [ ] ç™»å½•çŠ¶æ€ç®¡ç†
- [ ] SSO é€‰é¡¹ç•Œé¢
- [ ] é”™è¯¯æç¤ºå’ŒåŠ è½½çŠ¶æ€

**UI è¦æ±‚**:

- å“åº”å¼è®¾è®¡
- è¡¨å•éªŒè¯
- ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
- åŠ è½½çŠ¶æ€æŒ‡ç¤ºå™¨

#### 3.2 è®¤è¯ Hook

**ä»»åŠ¡**: åˆ›å»ºè®¤è¯çŠ¶æ€ç®¡ç† Hook
**æ–‡ä»¶**: `src/hooks/useAuth.tsx`
**åŠŸèƒ½**:

- [ ] ç”¨æˆ·çŠ¶æ€ç®¡ç†
- [ ] ç™»å½•/é€€å‡ºæ–¹æ³•
- [ ] è‡ªåŠ¨ token åˆ·æ–°
- [ ] è®¤è¯çŠ¶æ€æŒä¹…åŒ–

**ä»£ç ç¤ºä¾‹**:

```typescript
export function useAuth() {
  return {
    user: User | null
    isLoading: boolean
    isAuthenticated: boolean
    signin: (phone: string, code: string, forceLogout?: boolean) => Promise<void>
    signout: () => Promise<void>
    sendCode: (phone: string) => Promise<void>
  }
}
```

#### 3.3 è®¤è¯å®ˆå«ç»„ä»¶

**ä»»åŠ¡**: åˆ›å»ºè·¯ç”±ä¿æŠ¤ç»„ä»¶
**æ–‡ä»¶**: `src/components/auth/AuthGuard.tsx`
**åŠŸèƒ½**:

- [ ] è®¤è¯çŠ¶æ€æ£€æŸ¥
- [ ] æœªè®¤è¯ç”¨æˆ·é‡å®šå‘
- [ ] åŠ è½½çŠ¶æ€å¤„ç†
- [ ] é”™è¯¯è¾¹ç•Œå¤„ç†

### Phase 4: ä¸­é—´ä»¶å’Œè·¯ç”±ä¿æŠ¤ (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

#### 4.1 è®¤è¯ä¸­é—´ä»¶

**ä»»åŠ¡**: å®ç° Next.js ä¸­é—´ä»¶è®¤è¯
**æ–‡ä»¶**: `middleware.ts`
**åŠŸèƒ½**:

- [ ] è·¯ç”±çº§åˆ«çš„è®¤è¯æ£€æŸ¥
- [ ] Token éªŒè¯å’Œç‰ˆæœ¬æ£€æŸ¥
- [ ] è‡ªåŠ¨é‡å®šå‘é€»è¾‘
- [ ] å…¬å¼€è·¯ç”±é…ç½®

**ä»£ç ç¤ºä¾‹**:

```typescript
export async function middleware(request: NextRequest) {
  // æ£€æŸ¥å—ä¿æŠ¤çš„è·¯ç”±
  // éªŒè¯JWT token
  // å¤„ç†é‡å®šå‘
}

export const config = {
  matcher: ["/((?!api/auth|auth|_next/static|_next/image|favicon.ico).*)"],
};
```

#### 4.2 å—ä¿æŠ¤é¡µé¢æ”¹é€ 

**ä»»åŠ¡**: ä¸ºç°æœ‰é¡µé¢æ·»åŠ è®¤è¯ä¿æŠ¤
**æ–‡ä»¶**:

- `src/app/page.tsx`
- `src/app/frontend-validation/page.tsx`
  **åŠŸèƒ½**:
- [ ] æ·»åŠ  AuthGuard åŒ…è£…
- [ ] ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
- [ ] é€€å‡ºç™»å½•åŠŸèƒ½

### Phase 5: å•ç‚¹ç™»å½•(SSO)å¢å¼º (ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­)

#### 5.1 æ–‡ä»¶å¹¶å‘å®‰å…¨

**ä»»åŠ¡**: å®ç°æ–‡ä»¶æ“ä½œé”æœºåˆ¶
**æ–‡ä»¶**: `src/lib/fileLock.ts`
**åŠŸèƒ½**:

- [ ] æ–‡ä»¶çº§åˆ«äº’æ–¥é”
- [ ] å¹¶å‘æ“ä½œé˜Ÿåˆ—
- [ ] è¶…æ—¶å¤„ç†æœºåˆ¶
- [ ] é”™è¯¯æ¢å¤

#### 5.2 SSO ç”¨æˆ·ç•Œé¢å¢å¼º

**ä»»åŠ¡**: ä¼˜åŒ–å•ç‚¹ç™»å½•ç”¨æˆ·ä½“éªŒ
**æ–‡ä»¶**: `src/components/auth/SSOOptions.tsx`
**åŠŸèƒ½**:

- [ ] æ´»è·ƒä¼šè¯æ£€æµ‹æç¤º
- [ ] å¼ºåˆ¶é€€å‡ºç¡®è®¤å¯¹è¯æ¡†
- [ ] æœ€åç™»å½•æ—¶é—´æ˜¾ç¤º
- [ ] è®¾å¤‡ä¿¡æ¯å±•ç¤º(å¯é€‰)

#### 5.3 ä¼šè¯ç®¡ç†ç•Œé¢

**ä»»åŠ¡**: åˆ›å»ºç”¨æˆ·ä¼šè¯ç®¡ç†é¡µé¢
**æ–‡ä»¶**: `src/app/auth/sessions/page.tsx`
**åŠŸèƒ½**:

- [ ] å½“å‰æ´»è·ƒä¼šè¯åˆ—è¡¨
- [ ] æ‰‹åŠ¨é€€å‡ºç‰¹å®šä¼šè¯
- [ ] ä¼šè¯å†å²è®°å½•
- [ ] å®‰å…¨è®¾ç½®

### Phase 6: ç¬¬ä¸‰æ–¹ç™»å½•é›†æˆ (ä¼˜å…ˆçº§: ğŸŸ¢ ä½)

#### 6.1 å¾®ä¿¡ç™»å½•

**ä»»åŠ¡**: é›†æˆå¾®ä¿¡ç™»å½•
**æ–‡ä»¶**: `src/app/api/auth/wechat/route.ts`
**åŠŸèƒ½**:

- [ ] å¾®ä¿¡ OAuth é…ç½®
- [ ] æˆæƒå›è°ƒå¤„ç†
- [ ] ç”¨æˆ·ä¿¡æ¯è·å–
- [ ] è´¦å·ç»‘å®šé€»è¾‘

#### 6.2 æ”¯ä»˜å®ç™»å½•

**ä»»åŠ¡**: é›†æˆæ”¯ä»˜å®ç™»å½•
**æ–‡ä»¶**: `src/app/api/auth/alipay/route.ts`
**åŠŸèƒ½**:

- [ ] æ”¯ä»˜å® OAuth é…ç½®
- [ ] æˆæƒå›è°ƒå¤„ç†
- [ ] ç”¨æˆ·ä¿¡æ¯è·å–
- [ ] è´¦å·ç»‘å®šé€»è¾‘

### Phase 7: æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ (ä¼˜å…ˆçº§: ğŸŸ¢ ä½)

#### 7.1 ç¼“å­˜æœºåˆ¶

**ä»»åŠ¡**: æ·»åŠ ç”¨æˆ·æ•°æ®ç¼“å­˜
**åŠŸèƒ½**:

- [ ] å†…å­˜ç¼“å­˜å®ç°
- [ ] ç¼“å­˜å¤±æ•ˆç­–ç•¥
- [ ] ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

#### 7.2 æ—¥å¿—å’Œç›‘æ§

**ä»»åŠ¡**: æ·»åŠ è®¤è¯ç›¸å…³æ—¥å¿—
**åŠŸèƒ½**:

- [ ] ç™»å½•/é€€å‡ºæ—¥å¿—
- [ ] å®‰å…¨äº‹ä»¶è®°å½•
- [ ] æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- [ ] å¼‚å¸¸å‘Šè­¦æœºåˆ¶

## ğŸ”§ ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env.local
JWT_SECRET=your-super-secret-jwt-key-here
NEXT_PUBLIC_APP_URL=http://localhost:3000

# ç¬¬ä¸‰æ–¹ç™»å½•é…ç½®(å¯é€‰)
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret
ALIPAY_APP_ID=your-alipay-app-id
ALIPAY_PRIVATE_KEY=your-alipay-private-key

# çŸ­ä¿¡æœåŠ¡é…ç½®(å¯é€‰)
SMS_ACCESS_KEY=your-sms-access-key
SMS_SECRET_KEY=your-sms-secret-key
```

### 2. ä¾èµ–åŒ…å®‰è£…

```bash
npm install jose node-cache
npm install -D @types/node-cache
```

### 3. ç›®å½•ç»“æ„åˆ›å»º

```bash
mkdir -p data
mkdir -p src/app/auth/{signin,profile,sessions}
mkdir -p src/components/auth
mkdir -p src/hooks
```

## ğŸ“Š éªŒæ”¶æ ‡å‡†

### 1. åŠŸèƒ½éªŒæ”¶

- [ ] ç”¨æˆ·å¯ä»¥é€šè¿‡æ‰‹æœºéªŒè¯ç æˆåŠŸç™»å½•
- [ ] ç™»å½•åå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„é¡µé¢
- [ ] ç”¨æˆ·å¯ä»¥å®‰å…¨é€€å‡ºç™»å½•
- [ ] å•ç‚¹ç™»å½•åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ä¼šè¯ç®¡ç†åŠŸèƒ½å®Œæ•´

### 2. å®‰å…¨éªŒæ”¶

- [ ] JWT token å®‰å…¨ç”Ÿæˆå’ŒéªŒè¯
- [ ] æ•æ„Ÿä¿¡æ¯ä¸åœ¨å‰ç«¯æš´éœ²
- [ ] CSRF å’Œ XSS é˜²æŠ¤æœ‰æ•ˆ
- [ ] æ–‡ä»¶å­˜å‚¨æƒé™æ­£ç¡®

### 3. æ€§èƒ½éªŒæ”¶

- [ ] ç™»å½•å“åº”æ—¶é—´ < 2 ç§’
- [ ] é¡µé¢åŠ è½½æ—¶é—´ < 3 ç§’
- [ ] æ–‡ä»¶å¹¶å‘æ“ä½œå®‰å…¨
- [ ] å†…å­˜ä½¿ç”¨åˆç†

### 4. ç”¨æˆ·ä½“éªŒéªŒæ”¶

- [ ] ç•Œé¢å‹å¥½ç›´è§‚
- [ ] é”™è¯¯æç¤ºæ¸…æ™°
- [ ] åŠ è½½çŠ¶æ€æ˜ç¡®
- [ ] å“åº”å¼è®¾è®¡è‰¯å¥½

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# ç¡®ä¿æ•°æ®ç›®å½•æƒé™
chmod 755 data/
chmod 644 data/*.json

# è®¾ç½®ç¯å¢ƒå˜é‡
export JWT_SECRET="production-secret-key"
export NODE_ENV="production"
```

### 2. å®‰å…¨æ£€æŸ¥æ¸…å•

- [ ] JWT Secret è¶³å¤Ÿå¤æ‚
- [ ] æ–‡ä»¶æƒé™è®¾ç½®æ­£ç¡®
- [ ] HTTPS é…ç½®å¯ç”¨
- [ ] æ•æ„Ÿä¿¡æ¯ä¸åœ¨ä»£ç ä¸­

### 3. ç›‘æ§é…ç½®

- [ ] ç™»å½•å¤±è´¥ç‡ç›‘æ§
- [ ] æ–‡ä»¶æ“ä½œå¼‚å¸¸å‘Šè­¦
- [ ] æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- [ ] å®‰å…¨äº‹ä»¶è®°å½•

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024-01-15  
**æ›´æ–°æ—¶é—´**: 2024-01-15  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ

è¿™ä»½æ–‡æ¡£æä¾›äº†å®Œæ•´çš„ç”¨æˆ·è®¤è¯ç³»ç»Ÿå®ç°æŒ‡å—ï¼ŒåŒ…å«è¯¦ç»†çš„æŠ€æœ¯æ–¹æ¡ˆã€ä»»åŠ¡åˆ†è§£å’ŒéªŒæ”¶æ ‡å‡†ã€‚å»ºè®®æŒ‰ç…§ Phase é¡ºåºé€æ­¥å®æ–½ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µçš„è´¨é‡å’Œç¨³å®šæ€§ã€‚
