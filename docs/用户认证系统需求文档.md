# 🔐 用户认证系统完整需求文档

## 📋 项目概述

### 项目背景

Excel 验证应用需要用户认证系统，支持多种登录方式，实现用户会话管理和单点登录功能。

### 技术栈

- **框架**: Next.js 14 (App Router)
- **认证**: JWT + 文件存储
- **登录方式**: 手机验证码、微信、支付宝
- **存储**: 本地文件系统 (JSON)

## 🎯 功能需求

### 1. 用户认证功能

#### 1.1 登录方式

- **手机验证码登录** (主要方式)

  - 支持中国大陆手机号格式验证
  - 6 位数字验证码
  - 验证码有效期 5 分钟
  - 防刷机制：同一手机号 1 分钟内最多发送 1 次

- **微信登录** (可选)

  - 微信扫码登录
  - 获取用户基本信息
  - 绑定手机号

- **支付宝登录** (可选)
  - 支付宝授权登录
  - 获取用户基本信息
  - 绑定手机号

#### 1.2 用户信息管理

- 用户基本信息：ID、手机号、昵称、头像
- 登录记录：创建时间、最后登录时间
- 第三方账号绑定信息

#### 1.3 会话管理

- JWT Token 认证
- Token 有效期 7 天
- 自动续期机制
- 安全退出登录

### 2. 单点登录(SSO)功能

#### 2.1 核心需求

- **问题**: 用户在新浏览器登录时，旧浏览器不会自动退出
- **解决方案**: Token 版本控制机制
- **用户选择**: 登录时可选择是否强制退出其他设备

#### 2.2 实现策略

- Token 版本号机制
- 智能检测活跃会话
- 用户友好的提示界面
- 强制退出确认机制

### 3. 安全要求

#### 3.1 数据安全

- 敏感信息加密存储
- JWT Secret 安全管理
- 防止 CSRF 攻击
- XSS 防护

#### 3.2 访问控制

- 路由级别的认证保护
- API 接口权限验证
- 会话超时处理

## 🏗️ 技术实现方案

### 1. 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端页面      │    │   API路由       │    │   文件存储      │
│                 │    │                 │    │                 │
│ ├─登录页面      │◄──►│ ├─认证API       │◄──►│ ├─users.json    │
│ ├─用户中心      │    │ ├─验证码API     │    │ ├─sessions.json │
│ └─受保护页面    │    │ └─第三方登录API │    │ └─codes.json    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         ▲                       ▲
         │                       │
         └───────────────────────┘
              JWT Token 认证
```

### 2. 数据模型设计

#### 2.1 用户数据结构

```typescript
interface User {
  id: string; // 用户唯一ID
  phone?: string; // 手机号
  email?: string; // 邮箱
  name?: string; // 用户昵称
  avatar?: string; // 头像URL
  provider?: "phone" | "wechat" | "alipay"; // 登录方式
  providerAccountId?: string; // 第三方账号ID
  tokenVersion: number; // Token版本号(SSO关键)
  createdAt: string; // 创建时间
  lastLoginAt: string; // 最后登录时间
}
```

#### 2.2 JWT 载荷结构

```typescript
interface JWTPayload {
  userId: string; // 用户ID
  phone?: string; // 手机号
  name?: string; // 用户名
  tokenVersion: number; // Token版本号
  iat: number; // 签发时间
  exp: number; // 过期时间
}
```

#### 2.3 验证码数据结构

```typescript
interface VerificationCode {
  phone: string; // 手机号
  code: string; // 验证码
  createdAt: string; // 创建时间
  expiresAt: string; // 过期时间
  attempts: number; // 尝试次数
}
```

### 3. 文件存储方案

#### 3.1 存储结构

```
data/
├── users.json              # 用户数据
├── verification-codes.json # 验证码数据
├── sessions.json           # 会话记录(可选)
└── validation-records.json # 验证记录(现有)
```

#### 3.2 并发安全机制

```typescript
// 文件锁机制
const locks = new Map<string, Promise<any>>();

async function withFileLock<T>(
  filePath: string,
  operation: () => Promise<T>
): Promise<T> {
  // 实现文件级别的互斥锁
}
```

### 4. API 接口设计

#### 4.1 认证相关接口

```
POST /api/auth/send-code     # 发送验证码
POST /api/auth/signin        # 用户登录
POST /api/auth/signout       # 用户退出
GET  /api/auth/me           # 获取当前用户信息
POST /api/auth/check-session # 检查活跃会话
```

#### 4.2 第三方登录接口

```
GET  /api/auth/wechat       # 微信登录
GET  /api/auth/alipay       # 支付宝登录
POST /api/auth/bind-phone   # 绑定手机号
```

### 5. 前端页面结构

#### 5.1 页面路由

```
/auth/signin                # 登录页面
/auth/profile              # 用户中心
/auth/bind-phone           # 绑定手机号
/                          # 主页(需要认证)
/frontend-validation       # 前端验证(需要认证)
```

#### 5.2 组件结构

```
src/
├── app/
│   ├── auth/
│   │   ├── signin/page.tsx        # 登录页面
│   │   ├── profile/page.tsx       # 用户中心
│   │   └── bind-phone/page.tsx    # 绑定手机号
│   ├── api/auth/                  # 认证API
│   └── (protected)/               # 受保护的页面
├── components/
│   ├── auth/
│   │   ├── LoginForm.tsx          # 登录表单
│   │   ├── PhoneInput.tsx         # 手机号输入
│   │   ├── CodeInput.tsx          # 验证码输入
│   │   └── SSOOptions.tsx         # 单点登录选项
│   └── layout/
│       ├── AuthGuard.tsx          # 认证守卫
│       └── UserMenu.tsx           # 用户菜单
├── hooks/
│   ├── useAuth.tsx                # 认证Hook
│   └── useLocalStorage.tsx        # 本地存储Hook
└── lib/
    ├── auth.ts                    # 认证工具
    ├── jwt.ts                     # JWT工具
    ├── fileStorage.ts             # 文件存储
    ├── fileLock.ts                # 文件锁
    └── validators.ts              # 验证器
```

## 📝 详细实现任务

### Phase 1: 基础认证系统 (优先级: 🔥 高)

#### 1.1 文件存储基础设施

**任务**: 创建用户数据存储和管理系统
**文件**: `src/lib/fileStorage.ts`
**功能**:

- [ ] 实现 `User` 接口定义
- [ ] 创建 `UserStorage` 类
- [ ] 实现用户 CRUD 操作
- [ ] 添加 `tokenVersion` 字段支持
- [ ] 实现文件读写安全机制

**代码示例**:

```typescript
export class UserStorage {
  static async create(
    userData: Omit<User, "id" | "createdAt" | "lastLoginAt" | "tokenVersion">
  ): Promise<User>;
  static async findById(id: string): Promise<User | null>;
  static async findByPhone(phone: string): Promise<User | null>;
  static async update(id: string, updates: Partial<User>): Promise<User | null>;
  static async invalidateAllTokens(userId: string): Promise<void>;
}
```

#### 1.2 JWT 认证系统

**任务**: 实现 JWT token 生成和验证
**文件**: `src/lib/jwt.ts`
**功能**:

- [ ] JWT token 生成 (`signToken`)
- [ ] JWT token 验证 (`verifyToken`)
- [ ] Token 版本控制支持
- [ ] 安全配置管理

**代码示例**:

```typescript
export async function signToken(
  payload: Omit<JWTPayload, "iat" | "exp">
): Promise<string>;
export async function verifyToken(token: string): Promise<JWTPayload | null>;
```

#### 1.3 验证码系统

**任务**: 实现手机验证码发送和验证
**文件**: `src/lib/verificationCode.ts`
**功能**:

- [ ] 验证码生成和存储
- [ ] 验证码验证逻辑
- [ ] 防刷机制
- [ ] 过期清理机制

**代码示例**:

```typescript
export class VerificationCodeService {
  static async sendCode(
    phone: string
  ): Promise<{ success: boolean; message: string }>;
  static async verifyCode(phone: string, code: string): Promise<boolean>;
  static async cleanExpiredCodes(): Promise<void>;
}
```

### Phase 2: API 接口实现 (优先级: 🔥 高)

#### 2.1 发送验证码接口

**任务**: 实现验证码发送 API
**文件**: `src/app/api/auth/send-code/route.ts`
**功能**:

- [ ] 手机号格式验证
- [ ] 防刷机制检查
- [ ] 验证码生成和发送
- [ ] 错误处理和响应

**接口规范**:

```typescript
// POST /api/auth/send-code
Request: { phone: string }
Response: {
  success: boolean
  message: string
  cooldown?: number  // 剩余冷却时间(秒)
}
```

#### 2.2 用户登录接口

**任务**: 实现用户登录 API
**文件**: `src/app/api/auth/signin/route.ts`
**功能**:

- [ ] 验证码验证
- [ ] 用户创建/查找
- [ ] JWT token 生成
- [ ] SSO 强制退出逻辑
- [ ] Cookie 设置

**接口规范**:

```typescript
// POST /api/auth/signin
Request: {
  phone: string
  code: string
  forceLogout?: boolean  // 是否强制退出其他设备
}
Response: {
  success: boolean
  user: {
    id: string
    phone: string
    name?: string
    avatar?: string
  }
  forcedLogout?: boolean  // 是否强制退出了其他设备
}
```

#### 2.3 用户信息接口

**任务**: 实现获取当前用户信息 API
**文件**: `src/app/api/auth/me/route.ts`
**功能**:

- [ ] Token 验证
- [ ] 用户信息返回
- [ ] 错误处理

#### 2.4 退出登录接口

**任务**: 实现用户退出 API
**文件**: `src/app/api/auth/signout/route.ts`
**功能**:

- [ ] 清除 Cookie
- [ ] 可选的 token 失效
- [ ] 响应处理

#### 2.5 会话检查接口

**任务**: 实现活跃会话检查 API
**文件**: `src/app/api/auth/check-session/route.ts`
**功能**:

- [ ] 检查用户最近登录活动
- [ ] 返回会话状态信息
- [ ] 支持 SSO 决策

### Phase 3: 前端认证界面 (优先级: 🔥 高)

#### 3.1 登录页面

**任务**: 创建用户登录界面
**文件**: `src/app/auth/signin/page.tsx`
**功能**:

- [ ] 手机号输入和验证
- [ ] 验证码发送和输入
- [ ] 登录状态管理
- [ ] SSO 选项界面
- [ ] 错误提示和加载状态

**UI 要求**:

- 响应式设计
- 表单验证
- 用户友好的错误提示
- 加载状态指示器

#### 3.2 认证 Hook

**任务**: 创建认证状态管理 Hook
**文件**: `src/hooks/useAuth.tsx`
**功能**:

- [ ] 用户状态管理
- [ ] 登录/退出方法
- [ ] 自动 token 刷新
- [ ] 认证状态持久化

**代码示例**:

```typescript
export function useAuth() {
  return {
    user: User | null
    isLoading: boolean
    isAuthenticated: boolean
    signin: (phone: string, code: string, forceLogout?: boolean) => Promise<void>
    signout: () => Promise<void>
    sendCode: (phone: string) => Promise<void>
  }
}
```

#### 3.3 认证守卫组件

**任务**: 创建路由保护组件
**文件**: `src/components/auth/AuthGuard.tsx`
**功能**:

- [ ] 认证状态检查
- [ ] 未认证用户重定向
- [ ] 加载状态处理
- [ ] 错误边界处理

### Phase 4: 中间件和路由保护 (优先级: 🟡 中)

#### 4.1 认证中间件

**任务**: 实现 Next.js 中间件认证
**文件**: `middleware.ts`
**功能**:

- [ ] 路由级别的认证检查
- [ ] Token 验证和版本检查
- [ ] 自动重定向逻辑
- [ ] 公开路由配置

**代码示例**:

```typescript
export async function middleware(request: NextRequest) {
  // 检查受保护的路由
  // 验证JWT token
  // 处理重定向
}

export const config = {
  matcher: ["/((?!api/auth|auth|_next/static|_next/image|favicon.ico).*)"],
};
```

#### 4.2 受保护页面改造

**任务**: 为现有页面添加认证保护
**文件**:

- `src/app/page.tsx`
- `src/app/frontend-validation/page.tsx`
  **功能**:
- [ ] 添加 AuthGuard 包装
- [ ] 用户信息显示
- [ ] 退出登录功能

### Phase 5: 单点登录(SSO)增强 (优先级: 🟡 中)

#### 5.1 文件并发安全

**任务**: 实现文件操作锁机制
**文件**: `src/lib/fileLock.ts`
**功能**:

- [ ] 文件级别互斥锁
- [ ] 并发操作队列
- [ ] 超时处理机制
- [ ] 错误恢复

#### 5.2 SSO 用户界面增强

**任务**: 优化单点登录用户体验
**文件**: `src/components/auth/SSOOptions.tsx`
**功能**:

- [ ] 活跃会话检测提示
- [ ] 强制退出确认对话框
- [ ] 最后登录时间显示
- [ ] 设备信息展示(可选)

#### 5.3 会话管理界面

**任务**: 创建用户会话管理页面
**文件**: `src/app/auth/sessions/page.tsx`
**功能**:

- [ ] 当前活跃会话列表
- [ ] 手动退出特定会话
- [ ] 会话历史记录
- [ ] 安全设置

### Phase 6: 第三方登录集成 (优先级: 🟢 低)

#### 6.1 微信登录

**任务**: 集成微信登录
**文件**: `src/app/api/auth/wechat/route.ts`
**功能**:

- [ ] 微信 OAuth 配置
- [ ] 授权回调处理
- [ ] 用户信息获取
- [ ] 账号绑定逻辑

#### 6.2 支付宝登录

**任务**: 集成支付宝登录
**文件**: `src/app/api/auth/alipay/route.ts`
**功能**:

- [ ] 支付宝 OAuth 配置
- [ ] 授权回调处理
- [ ] 用户信息获取
- [ ] 账号绑定逻辑

### Phase 7: 性能优化和监控 (优先级: 🟢 低)

#### 7.1 缓存机制

**任务**: 添加用户数据缓存
**功能**:

- [ ] 内存缓存实现
- [ ] 缓存失效策略
- [ ] 缓存命中率监控

#### 7.2 日志和监控

**任务**: 添加认证相关日志
**功能**:

- [ ] 登录/退出日志
- [ ] 安全事件记录
- [ ] 性能指标收集
- [ ] 异常告警机制

## 🔧 环境配置

### 1. 环境变量配置

```bash
# .env.local
JWT_SECRET=your-super-secret-jwt-key-here
NEXT_PUBLIC_APP_URL=http://localhost:3000

# 第三方登录配置(可选)
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret
ALIPAY_APP_ID=your-alipay-app-id
ALIPAY_PRIVATE_KEY=your-alipay-private-key

# 短信服务配置(可选)
SMS_ACCESS_KEY=your-sms-access-key
SMS_SECRET_KEY=your-sms-secret-key
```

### 2. 依赖包安装

```bash
npm install jose node-cache
npm install -D @types/node-cache
```

### 3. 目录结构创建

```bash
mkdir -p data
mkdir -p src/app/auth/{signin,profile,sessions}
mkdir -p src/components/auth
mkdir -p src/hooks
```

## 📊 验收标准

### 1. 功能验收

- [ ] 用户可以通过手机验证码成功登录
- [ ] 登录后可以访问受保护的页面
- [ ] 用户可以安全退出登录
- [ ] 单点登录功能正常工作
- [ ] 会话管理功能完整

### 2. 安全验收

- [ ] JWT token 安全生成和验证
- [ ] 敏感信息不在前端暴露
- [ ] CSRF 和 XSS 防护有效
- [ ] 文件存储权限正确

### 3. 性能验收

- [ ] 登录响应时间 < 2 秒
- [ ] 页面加载时间 < 3 秒
- [ ] 文件并发操作安全
- [ ] 内存使用合理

### 4. 用户体验验收

- [ ] 界面友好直观
- [ ] 错误提示清晰
- [ ] 加载状态明确
- [ ] 响应式设计良好

## 🚀 部署指南

### 1. 生产环境配置

```bash
# 确保数据目录权限
chmod 755 data/
chmod 644 data/*.json

# 设置环境变量
export JWT_SECRET="production-secret-key"
export NODE_ENV="production"
```

### 2. 安全检查清单

- [ ] JWT Secret 足够复杂
- [ ] 文件权限设置正确
- [ ] HTTPS 配置启用
- [ ] 敏感信息不在代码中

### 3. 监控配置

- [ ] 登录失败率监控
- [ ] 文件操作异常告警
- [ ] 性能指标收集
- [ ] 安全事件记录

---

**文档版本**: v1.0  
**创建时间**: 2024-01-15  
**更新时间**: 2024-01-15  
**负责人**: 开发团队

这份文档提供了完整的用户认证系统实现指南，包含详细的技术方案、任务分解和验收标准。建议按照 Phase 顺序逐步实施，确保每个阶段的质量和稳定性。
